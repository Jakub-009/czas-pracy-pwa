<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Godziny pracy</title>
  <meta name="theme-color" content="#f6f7fb" />
  <meta name="color-scheme" content="light">
  <link rel="manifest" href="/czas-pracy-pwa/manifest.webmanifest">

  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:#f6f7fb;color:#111}
    .wrap{max-width:980px;margin:24px auto;padding:0 14px}
    .card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
    @media(max-width:820px){.col-3,.col-4,.col-6{grid-column:span 12}}
    label{display:block;font-size:12px;color:#444;margin-bottom:6px}
    input,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d7dbe7;background:#fff;font-size:14px;box-sizing:border-box}
    textarea{min-height:44px;resize:vertical}
    button{cursor:pointer;border:none;background:#111;color:#fff}
    button.secondary{background:#eef1f8;color:#111;border:1px solid #d7dbe7}
    button.danger{background:#d92d20}
    h1{font-size:20px;margin:0 0 10px}
    h2{font-size:16px;margin:0 0 10px}
    .muted{color:#666;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1;min-width:160px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef1f8;font-size:12px}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eef1f8;text-align:left;font-size:14px;vertical-align:top}
    th{font-size:12px;color:#555}
    .right{text-align:right}

    .timesCell{line-height:1.25}
    .shiftRow{padding:6px 0;border-bottom:1px dashed #e7ebf6}
    .shiftRow:last-child{border-bottom:none}
    .shiftRow .lbl{display:block;font-size:11px;color:#666;margin-top:2px}
    .shiftRow .val{display:block;font-weight:700}
    .shiftRow .miniRow{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .shiftRow .miniBtns{display:flex;gap:6px;flex:0 0 auto}
    .miniBtn{
      padding:6px 8px;border-radius:10px;border:1px solid #d7dbe7;background:#eef1f8;color:#111;
      font-size:12px;cursor:pointer
    }
    .miniBtn.danger{background:#ffe6e3;border-color:#ffb4ab;color:#7a1410}

    /* mobilnie: nie pokazuj wypłaty w tabeli (jest na górze w podsumowaniu) */
    @media (max-width:520px){
      th.payCol, td.payCol{display:none;}
      th.actionsCol, td.actionsCol{white-space:nowrap;}
      td.noteCol{min-width:160px;}
    }

    /* details / trójkąt + animacja */
    details{border-radius:12px}
    details summary{
      cursor:pointer;
      font-weight:700;
      user-select:none;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:2px 0;
    }
    details summary::-webkit-details-marker{display:none;}
    .chev{
      width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;
      border-radius:8px;background:#eef1f8;border:1px solid #d7dbe7;
      transition:transform .18s ease;
      flex:0 0 auto;
      margin-left:10px;
    }
    details[open] .chev{transform:rotate(180deg);}
    .panel{overflow:hidden;animation:panelIn .18s ease;}
    @keyframes panelIn{
      from{opacity:.4; transform:translateY(-4px)}
      to{opacity:1; transform:translateY(0)}
    }

    /* druk / PDF */
    @media print{
      body{background:#fff}
      .wrap{margin:0;padding:0;max-width:none}
      .card{box-shadow:none;border-radius:0;padding:0}
      button, input, textarea, #status, details, .miniBtn{display:none !important}
      table{font-size:12px}
      th,td{padding:6px}
      th.payCol, td.payCol{display:table-cell !important;}
      .shiftRow{border-bottom:1px solid #eee}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" style="margin-bottom:14px;">
      <h1>Godziny pracy ⏱️</h1>
    </div>

    <!-- Dodaj dzień -->
    <div class="grid" style="margin-bottom:14px;">
      <div class="card col-12">
        <h2>Dodaj dzień</h2>

        <div class="grid">
          <div class="col-3">
            <label>Data</label>
            <input id="date" type="date" />
          </div>
          <div class="col-3">
            <label>Wejście</label>
            <input id="start" type="time" />
          </div>
          <div class="col-3">
            <label>Wyjście</label>
            <input id="end" type="time" />
          </div>

          <div class="col-12">
            <label>Notatka do dnia</label>
            <textarea id="note" placeholder="Opcjonalnie..."></textarea>
          </div>

          <div class="col-3">
            <label>&nbsp;</label>
            <button id="addHoursBtn">Dodaj (kolejny) zakres</button>
          </div>

          <div class="col-12">
            <div class="muted" style="margin-top:2px;" id="status"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ustawienia pracy -->
    <div class="grid" style="margin-bottom:14px;">
      <div class="card col-12">
        <details id="extrasPanel">
          <summary>
            <span>Ustawienia pracy</span>
            <span class="chev">▾</span>
          </summary>
          <div class="panel">
            <div class="grid" style="margin-top:12px;">
              <div class="col-4">
                <label>Stawka godzinowa (PLN)</label>
                <input id="rate" type="number" step="0.01" min="0" value="40" />
              </div>
            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- Podsumowanie -->
    <div class="grid">
      <div class="card col-12">
        <div class="row" style="align-items:center;">
          <h2 style="margin:0;">Podsumowanie miesiąca</h2>
          <span class="pill" id="monthLabel"></span>
        </div>

        <div class="grid" style="margin-top:10px;">
          <div class="col-6">
            <div class="muted">Suma godzin</div>
            <div style="font-size:22px;font-weight:700" id="sumHours">0:00</div>
          </div>
          <div class="col-6">
            <div class="muted">Wypłata</div>
            <div style="font-size:22px;font-weight:700" id="sumPay">0,00 zł</div>
          </div>
        </div>

        <div style="margin-top:14px; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Wejście / Wyjście</th>
                <th>Notatka</th>
                <th class="right">Czas pracy</th>
                <th class="right payCol">Wypłata</th>
                <th class="right actionsCol">Akcje</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="secondary" id="printPdfBtn">Raport PDF / Wydrukuj</button>
        </div>
      </div>
    </div>

    <!-- Narzędzia -->
    <div class="grid" style="margin-top:14px;">
      <div class="card col-12">
        <details id="toolsPanel">
          <summary>
            <span>Narzędzia</span>
            <span class="chev">▾</span>
          </summary>
          <div class="panel">
            <div class="row" style="margin-top:12px;">
              <button class="danger" id="clearMonth">Usuń wpisy z tego miesiąca</button>
              <button class="secondary" id="backupJson">Backup JSON</button>
              <input id="restoreJson" type="file" accept="application/json" style="display:none" />
              <button class="secondary" id="restoreBtn">Przywróć z JSON</button>
            </div>
            <div class="muted" style="margin-top:8px;">
              Tip: rób backup raz na jakiś czas (Google Drive / mail) i masz spokój.
            </div>
          </div>
        </details>
      </div>
    </div>
  </div>

<script>
(() => {
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/czas-pracy-pwa/sw.js", { scope: "/czas-pracy-pwa/" });
  }

  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2,"0");

  const todayISO = () => {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  };

  const ym = (dateISO) => dateISO.slice(0,7);

  const fmtDMY = (dateISO) => {
    if (!dateISO) return "";
    const [y,m,d] = dateISO.split("-");
    return `${d}-${m}-${y}`;
  };

  const STORAGE_KEY = "worktime_pwa_v1";

  let db = load() || { settings:{ rate:40 }, entries:[] };

  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
  function load(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch { return null; }
  }

  function migrateIfNeeded(){
    // Jeśli mamy stare wpisy {date,start,end,note} -> przerób na {date, shifts:[{start,end}], note}
    let changed = false;
    db.entries = (Array.isArray(db.entries) ? db.entries : []).map(e=>{
      if (!e) return e;
      if (Array.isArray(e.shifts)) return e;

      const shifts = [];
      if (e.start && e.end) shifts.push({ start:e.start, end:e.end });

      const ne = { date:e.date, note:e.note || "", shifts };
      changed = true;
      return ne;
    });

    if (changed) save();
  }

  function normalize(){
    db.settings = db.settings || {};
    db.settings.rate = Number(db.settings.rate ?? 40);
    db.entries = Array.isArray(db.entries) ? db.entries : [];
    // upewnij się, że każdy dzień ma shifts[]
    for (const e of db.entries){
      e.shifts = Array.isArray(e.shifts) ? e.shifts : [];
      e.note = e.note || "";
    }
  }

  function setStatus(t){ $("status").textContent = t || ""; }

  function minutesBetween(dateISO, start, end) {
    const [y,m,d] = dateISO.split("-").map(Number);
    const [sh,sm] = start.split(":").map(Number);
    const [eh,em] = end.split(":").map(Number);
    const a = new Date(y,m-1,d,sh,sm,0,0);
    let b = new Date(y,m-1,d,eh,em,0,0);
    if (b < a) b = new Date(y,m-1,d+1,eh,em,0,0);
    return Math.round((b-a)/60000);
  }

  function fmtHM(mins){
    const h = Math.floor(mins/60);
    const m = mins%60;
    return `${h}:${pad2(m)}`;
  }

  function pln(x){ return x.toLocaleString("pl-PL",{style:"currency",currency:"PLN"}); }

  function readSettingsFromUI(){
    db.settings.rate = Number($("rate").value || 0);
  }
  function hydrateSettingsUI(){
    $("rate").value = db.settings.rate;
  }

  function getDay(date){
    return db.entries.find(e => e.date === date) || null;
  }

  function upsertDay(date, patch){
    const i = db.entries.findIndex(e => e.date === date);
    if (i >= 0) db.entries[i] = { ...db.entries[i], ...patch };
    else db.entries.push({ date, note:"", shifts:[], ...patch });
    db.entries.sort((a,b)=>a.date.localeCompare(b.date));
  }

  function deleteDay(dateISO){
    db.entries = db.entries.filter(e => e.date !== dateISO);
  }

  function deleteShift(dateISO, idx){
    const d = getDay(dateISO);
    if (!d) return;
    d.shifts.splice(idx, 1);
    save(); render();
  }

  function computeDayMinutes(day){
    let total = 0;
    for (const s of day.shifts){
      if (!s?.start || !s?.end) continue;
      total += Math.max(0, minutesBetween(day.date, s.start, s.end));
    }
    return total;
  }

  function currentMonth(){
    return ym($("date").value || todayISO());
  }

  function render(){
    normalize();
    readSettingsFromUI();

    const month = currentMonth();
    const [Y,M] = month.split("-");
    $("monthLabel").textContent = `${M}-${Y}`;

    const monthDays = db.entries.filter(e => ym(e.date)===month);

    let sumMin = 0;
    const rowsHtml = monthDays.map(day=>{
      const mins = computeDayMinutes(day);
      sumMin += mins;
      const pay = (mins/60)*(db.settings.rate||0);

      const safeNote = (day.note || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;");

      const shiftsHtml = (day.shifts.length ? day.shifts : [{start:"", end:""}]).map((s, idx)=>{
        const start = s.start || "-";
        const end = s.end || "-";
        const showDelete = day.shifts.length > 0 && (s.start || s.end);
        return `
          <div class="shiftRow">
            <div class="miniRow">
              <div>
                <span class="lbl">Wejście</span>
                <span class="val">${start}</span>
                <span class="lbl" style="margin-top:6px;">Wyjście</span>
                <span class="val">${end}</span>
              </div>
              <div class="miniBtns">
                ${showDelete ? `<button class="miniBtn danger" data-delshift="${day.date}" data-idx="${idx}" title="Usuń ten zakres">Usuń</button>` : ``}
              </div>
            </div>
          </div>
        `;
      }).join("");

      return `
        <tr>
          <td>${fmtDMY(day.date)}</td>
          <td class="timesCell">${shiftsHtml}</td>
          <td class="noteCol">${safeNote || "-"}</td>
          <td class="right">${mins ? fmtHM(mins) : "-"}</td>
          <td class="right payCol">${mins ? pln(pay) : "-"}</td>
          <td class="right actionsCol">
            <button class="secondary" data-edit="${day.date}" style="max-width:110px;">Edytuj</button>
            <button class="secondary" data-del="${day.date}" style="max-width:110px;">Usuń</button>
          </td>
        </tr>`;
    }).join("");

    $("rows").innerHTML = rowsHtml || `<tr><td colspan="6" class="muted">Brak wpisów w tym miesiącu.</td></tr>`;
    $("sumHours").textContent = fmtHM(sumMin);
    $("sumPay").textContent = pln((sumMin/60)*(db.settings.rate||0));

    // edit day to form
    document.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.onclick = ()=>{
        const date = btn.getAttribute("data-edit");
        const day = getDay(date);
        $("date").value = day.date;
        // w formie ustawiamy "ostatni" zakres (żeby łatwo dopisać kolejny)
        const last = day.shifts[day.shifts.length-1];
        $("start").value = last?.start || "";
        $("end").value = last?.end || "";
        $("note").value = day.note || "";
        setStatus("Wczytano dzień do edycji. Dodaj kolejny zakres przyciskiem.");
        render();
      };
    });

    // delete whole day
    document.querySelectorAll("[data-del]").forEach(btn=>{
      btn.onclick = ()=>{
        const date = btn.getAttribute("data-del");
        if (confirm("Usunąć CAŁY dzień " + fmtDMY(date) + " (wszystkie zakresy i notatkę)?")) {
          deleteDay(date); save(); render();
        }
      };
    });

    // delete single shift
    document.querySelectorAll("[data-delshift]").forEach(btn=>{
      btn.onclick = ()=>{
        const date = btn.getAttribute("data-delshift");
        const idx = Number(btn.getAttribute("data-idx"));
        if (Number.isNaN(idx)) return;
        if (confirm("Usunąć ten zakres godzin z dnia " + fmtDMY(date) + "?")) {
          deleteShift(date, idx);
        }
      };
    });

    save();
  }

  // backup/restore
  $("backupJson").onclick = ()=>{
    const blob = new Blob([JSON.stringify(db,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `czas-pracy-backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  $("restoreBtn").onclick = ()=> $("restoreJson").click();

  $("restoreJson").onchange = async (ev)=>{
    const f = ev.target.files?.[0];
    if (!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      db = obj;
      normalize();
      migrateIfNeeded();
      save();
      hydrateSettingsUI();
      render();
      setStatus("Przywrócono dane z pliku JSON.");
    }catch{
      alert("Nie udało się wczytać pliku JSON.");
    }
  };

  // Dodaj zakres + (opcjonalnie) notatka
  $("addHoursBtn").onclick = ()=>{
    const date = $("date").value;
    const start = $("start").value;
    const end = $("end").value;
    const note = ($("note").value || "").trim();

    if (!date) return alert("Wybierz datę.");

    // jeśli godziny wpisane częściowo
    if ((start && !end) || (!start && end)) {
      return alert("Uzupełnij wejście i wyjście (albo zostaw oba puste).");
    }

    // jeśli nic nie ma
    if (!start && !end && !note) {
      return alert("Wpisz godziny lub notatkę.");
    }

    readSettingsFromUI();

    // bierz obecny dzień albo stwórz
    const day = getDay(date) || { date, note:"", shifts:[] };

    // dopisz shift jeśli jest komplet godzin
    let addedShift = false;
    if (start && end) {
      day.shifts = Array.isArray(day.shifts) ? day.shifts : [];
      day.shifts.push({ start, end });
      addedShift = true;
      // wyczyść godziny, żeby łatwo wbić kolejny zakres
      $("start").value = "";
      $("end").value = "";
    }

    // nadpisz notatkę jeśli podana (zostaje jedna na dzień)
    let changedNote = false;
    if (note) {
      day.note = note;
      changedNote = true;
    }

    upsertDay(date, day);

    const msg = [
      addedShift ? "Dodano zakres godzin." : null,
      changedNote ? "Zapisano notatkę." : null
    ].filter(Boolean).join(" ");
    setStatus(msg || "Zapisano.");

    save();
    render();
  };

  // print / PDF
  $("printPdfBtn").onclick = ()=> window.print();

  // clear month
  $("clearMonth").onclick = ()=>{
    const month = currentMonth();
    const [Y,M] = month.split("-");
    if (!confirm("Usunąć wszystkie wpisy z miesiąca " + `${M}-${Y}` + "?")) return;
    db.entries = db.entries.filter(e => ym(e.date)!==month);
    save();
    render();
  };

  ["rate","date"].forEach(id=>{
    $(id).addEventListener("input", render);
    $(id).addEventListener("change", render);
  });

  // init
  $("date").value = todayISO();
  normalize();
  migrateIfNeeded();
  hydrateSettingsUI();
  render();
})();
</script>
</body>
</html>
