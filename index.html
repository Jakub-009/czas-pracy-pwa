<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Godziny pracy</title>
  <meta name="theme-color" content="#f6f7fb" />
  <meta name="color-scheme" content="light">
  <link rel="manifest" href="/czas-pracy-pwa/manifest.webmanifest">

<style>
  *{box-sizing:border-box}
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  body{margin:0;background:#f6f7fb;color:#111}
  .wrap{max-width:980px;margin:24px auto;padding:0 14px}
  .card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
  .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
  @media(max-width:820px){.col-3,.col-4,.col-6{grid-column:span 12}}
  label{display:block;font-size:12px;color:#444;margin-bottom:6px}
  input,button,textarea,select{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid #d7dbe7;
    background:#fff;
    font-size:14px;
  }
  textarea{min-height:44px;resize:vertical}
  button{cursor:pointer;border:none;background:#111;color:#fff}
  button.secondary{background:#eef1f8;color:#111;border:1px solid #d7dbe7}
  button.danger{background:#d92d20}
  h1{font-size:20px;margin:0 0 10px}
  h2{font-size:16px;margin:0 0 10px}
  .muted{color:#666;font-size:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row > *{flex:1;min-width:160px}

  /* ===== mały chevron bez tła (Opcja B) ===== */
  .chev{
    width:18px;height:18px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    flex:0 0 auto;
    margin-left:10px;
    transition:transform .18s ease;
    opacity:.65;
  }
  .chev::before{
    content:"";
    width:8px;height:8px;
    border-right:2px solid #111;
    border-bottom:2px solid #111;
    transform:rotate(45deg);
    display:block;
    margin-top:-1px;
  }
  details[open] .chev{transform:rotate(180deg)}
  details[open] .chev::before{margin-top:1px}

  /* details */
  details{border-radius:12px}
  details summary{
    cursor:pointer;
    font-weight:800;
    user-select:none;
    list-style:none;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:2px 0;
  }
  details summary::-webkit-details-marker{display:none;}
  .panel{overflow:hidden;animation:panelIn .18s ease;}
  @keyframes panelIn{
    from{opacity:.4; transform:translateY(-4px)}
    to{opacity:1; transform:translateY(0)}
  }

  /* ===== KALENDARZ (JEDNA, CZYSTA SEKCJA) ===== */
  .calWrap{width:100%;}
  .calHead{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:12px;}

  .monthBar{
    width:100%;
    background:#fff;
    border:1px solid #eef1f8;
    border-radius:14px;
    box-shadow:0 6px 18px rgba(0,0,0,.04);
    padding:12px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    position:relative;
    cursor:pointer;
    user-select:none;
    overflow:hidden;
  }
  .monthBar .txt{font-weight:900;font-size:15px;color:#1b2a3a;line-height:1.2}
  .monthBar .sub{font-size:12px;color:#666;margin-top:2px}
  #monthPick{
    position:absolute;
    inset:0;
    opacity:0;
    cursor:pointer;
  }

  .calGrid{
    display:grid;
    grid-template-columns:repeat(7, minmax(0, 1fr));
    gap:10px;
    width:100%;
  }
  .calDow{
    font-size:12px;
    color:#666;
    text-align:center;
    padding:6px 0;
  }

  .dayCell{
    background:#fff;
    border:1px solid #eef1f8;
    border-radius:14px;
    padding:10px;
    min-height:76px; /* desktop/tablet OK */
    box-shadow:0 6px 18px rgba(0,0,0,.04);
    cursor:pointer;
    display:flex;
    flex-direction:column;
    justify-content:flex-start;
    gap:6px;
    position:relative;
    overflow:hidden;
  }
  .dayCell:hover{border-color:#d7dbe7}

  .dayTop{display:flex;align-items:baseline;justify-content:space-between;gap:8px}
  .dayNum{font-size:18px;font-weight:750;color:#1b2a3a;line-height:1}
  .dayNum.has{font-weight:900}
  .dayNum.mutedNum{color:#9aa6b2;font-weight:700}
  .dayNum.weekend{color:#c53030}

  /* kropki statusu (Wariant 5) */
  .indRow{
    display:flex;
    gap:6px;
    align-items:center;
    margin-top:2px;
    min-height:10px;
  }
  .dot{
    width:8px;height:8px;border-radius:999px;
    display:inline-block;
    box-shadow:0 2px 8px rgba(0,0,0,.10);
  }
  .dot.hidden{visibility:hidden}
  .dot.shift{background:#50827C;}  /* zielona: godziny */
  .dot.note{background:#E5A823;}   /* żółta: notatka */

  .blankCell{
    border:none;
    background:transparent;
    box-shadow:none;
    pointer-events:none;
    min-height:76px;
  }

  /* Android/mobile-safe: tu jest KLUCZ (kafelki nie nachodzą) */
  @media(max-width:640px){
    .calGrid{gap:8px}
    .dayCell{
      padding:8px;
      border-radius:16px;
      min-height:auto;        /* zdejmujemy min-height */
      aspect-ratio: 1 / 1;    /* wymuszamy kwadrat */
      box-shadow:0 3px 10px rgba(0,0,0,.06);
    }
    .blankCell{
      min-height:auto;
      aspect-ratio: 1 / 1;
    }
    .dayNum{font-size:16px}
    .dot{width:7px;height:7px}
  }
  @media(max-width:420px){
    .calGrid{gap:6px}
  }

  /* ===== MODAL (dialog) ===== */
  dialog{
    border:none;border-radius:16px;padding:0;
    width:min(720px, calc(100vw - 22px));
    box-shadow:0 18px 60px rgba(0,0,0,.25);
  }
  dialog::backdrop{background:rgba(17,17,17,.45)}
  .modalHead{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:14px;border-bottom:1px solid #eef1f8;
    background:#fff;
    border-top-left-radius:16px;border-top-right-radius:16px;
  }
  .modalHead h3{margin:0;font-size:16px}
  .modalBody{padding:14px;background:#fff;border-bottom-left-radius:16px;border-bottom-right-radius:16px}

  .shiftList{display:grid;gap:10px;margin-top:10px}
  .shiftItem{
    border:1px solid #eef1f8;border-radius:14px;padding:10px;
    display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    background:#fff;
    box-shadow:0 6px 18px rgba(0,0,0,.04);
  }
  .shiftItem .times{font-weight:900}
  .shiftItem .mins{color:#666;font-size:12px;margin-top:2px}
  .miniBtn{
    width:auto;padding:8px 10px;border-radius:12px;border:1px solid #d7dbe7;background:#eef1f8;color:#111;
  }
  .miniBtn.danger{background:#ffe6e3;border-color:#ffb4ab;color:#7a1410}
  .divider{height:1px;background:#eef1f8;margin:14px 0}
  #status:empty{display:none;}

  @media print{
    body{background:#fff}
    .wrap{margin:0;padding:0;max-width:none}
    .card{box-shadow:none;border-radius:0;padding:0}
    button, input, textarea, details, dialog{display:none !important}
  }
</style>
</head>

<body>
  <div class="wrap">
    <div class="card" style="margin-bottom:14px;">
      <h1>Godziny pracy ⏱️</h1>
    </div>

    <!-- Dodawanie -->
    <div class="grid" style="margin-bottom:14px;">
      <div class="card col-12">
        <h2>Dodaj godziny pracy</h2>
        <div class="grid">
          <div class="col-3">
            <label>Data</label>
            <input id="date" type="date" />
          </div>
          <div class="col-3">
            <label>Wejście</label>
            <input id="start" type="time" />
          </div>
          <div class="col-3">
            <label>Wyjście</label>
            <input id="end" type="time" />
          </div>

          <div class="col-12">
            <label>Notatka</label>
            <textarea id="note" placeholder="Opcjonalnie..."></textarea>
          </div>

          <div class="col-3">
            <label>&nbsp;</label>
            <button id="addShiftBtn">Dodaj godziny</button>
          </div>

          <div class="col-12">
            <button class="secondary" id="openDayBtn">Pokaż szczegóły dnia</button>
            <div class="muted" id="status" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ustawienia -->
    <div class="grid" style="margin-bottom:14px;">
      <div class="card col-12">
        <details id="extrasPanel">
          <summary>
            <span>Ustawienia pracy</span>
            <span class="chev" aria-hidden="true"></span>
          </summary>
          <div class="panel">
            <div class="grid" style="margin-top:12px;">
              <div class="col-4">
                <label>Stawka godzinowa (PLN)</label>
                <input id="rate" type="number" step="0.01" min="0" value="40" />
              </div>
            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- Podsumowanie = kalendarz -->
    <div class="grid">
      <div class="card col-12">
        <div class="calHead">
          <div>
            <h2 style="margin:0;">Podsumowanie miesiąca</h2>
            <div class="muted">Kliknij dzień, żeby zobaczyć szczegóły i akcje.</div>
          </div>
        </div>

        <div class="monthBar" id="monthBar">
          <div>
            <div class="txt" id="monthLabelText">—</div>
            <div class="sub">Dotknij, aby zmienić miesiąc</div>
          </div>
          <span class="chev" aria-hidden="true"></span>
          <input id="monthPick" type="month" aria-label="Wybierz miesiąc" />
        </div>

        <div class="calWrap" style="margin-top:10px;">
          <div class="calGrid" id="dowRow" style="margin-bottom:6px;"></div>
          <div class="calGrid" id="calGrid"></div>
        </div>

        <div class="divider"></div>

        <div class="grid" style="margin-top:10px;">
          <div class="col-6">
            <div class="muted">Suma godzin</div>
            <div style="font-size:22px;font-weight:900" id="sumHours">0:00</div>
          </div>
          <div class="col-6">
            <div class="muted">Wypłata</div>
            <div style="font-size:22px;font-weight:900" id="sumPay">0,00 zł</div>
          </div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button class="secondary" id="printPdfBtn">Raport PDF / Wydrukuj</button>
        </div>
      </div>
    </div>

    <!-- Narzędzia -->
    <div class="grid" style="margin-top:14px;">
      <div class="card col-12">
        <details id="toolsPanel">
          <summary>
            <span>Narzędzia</span>
            <span class="chev" aria-hidden="true"></span>
          </summary>
          <div class="panel">
            <div class="row" style="margin-top:12px;">
              <button class="danger" id="clearMonth">Usuń wpisy z tego miesiąca</button>
              <button class="secondary" id="backupJson">Backup JSON</button>
              <input id="restoreJson" type="file" accept="application/json" style="display:none" />
              <button class="secondary" id="restoreBtn">Przywróć z JSON</button>
            </div>
            <div class="muted" style="margin-top:8px;">
              Tip: rób backup raz na jakiś czas (Google Drive / mail) i masz spokój.
            </div>
          </div>
        </details>
      </div>
    </div>
  </div>

  <!-- MODAL DNIA -->
  <dialog id="dayDialog">
    <div class="modalHead">
      <div>
        <h3 id="dlgTitle" style="margin:0;">Dzień</h3>
        <div class="muted" id="dlgMeta" style="margin-top:3px;"></div>
      </div>
      <button class="secondary" id="dlgClose" style="width:auto;">Zamknij</button>
    </div>

    <div class="modalBody">
      <div class="grid">
        <div class="col-12">
          <div class="row" style="gap:10px;align-items:stretch;">
            <div class="card" style="box-shadow:none;border:1px solid #eef1f8;">
              <div class="muted">Suma dnia</div>
              <div style="font-size:20px;font-weight:900" id="dlgSumHM">0:00</div>
            </div>
            <div class="card" style="box-shadow:none;border:1px solid #eef1f8;">
              <div class="muted">Wypłata dnia</div>
              <div style="font-size:20px;font-weight:900" id="dlgSumPay">0,00 zł</div>
            </div>
          </div>
        </div>

        <div class="col-6">
          <label>Dodaj kolejny zakres</label>
          <div class="row" style="gap:8px;">
            <input id="dlgStart" type="time" style="min-width:140px;" />
            <input id="dlgEnd" type="time" style="min-width:140px;" />
            <button id="dlgAddShift" style="width:auto;">Dodaj</button>
          </div>
          <div class="muted" style="margin-top:6px;">Możesz dodawać kilka zakresów (np. przerwa w ciągu dnia).</div>
        </div>

        <div class="col-6">
          <label>Notatka</label>
          <textarea id="dlgNote" placeholder="Opcjonalnie..."></textarea>
          <button class="secondary" id="dlgSaveNote" style="margin-top:8px;">Zapisz notatkę</button>
        </div>

        <div class="col-12">
          <div class="divider"></div>
          <div style="display:flex; justify-content:space-between; align-items:baseline; gap:10px; flex-wrap:wrap;">
            <div>
              <strong>Zakresy</strong>
              <div class="muted" id="dlgSummary"></div>
            </div>
            <button class="danger" id="dlgDeleteDay" style="width:auto;">Usuń cały dzień</button>
          </div>

          <div class="shiftList" id="dlgShifts"></div>
        </div>
      </div>
    </div>
  </dialog>

<script>
(() => {
  const showErr = (msg) => {
    const el = document.getElementById("status");
    if (el) el.textContent = "BŁĄD: " + msg;
  };
  window.addEventListener("error", (e) => showErr(e.message || "Nieznany błąd JS"));
  window.addEventListener("unhandledrejection", (e) => {
    showErr((e.reason && e.reason.message) ? e.reason.message : String(e.reason || "Promise error"));
  });

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/czas-pracy-pwa/sw.js", { scope: "/czas-pracy-pwa/" });
  }

  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2,"0");

  const todayISO = () => {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  };
  const ym = (dateISO) => dateISO.slice(0,7);

  const MON = ["sty","lut","mar","kwi","maj","cze","lip","sie","wrz","paź","lis","gru"];
  const fmtDMYText = (dateISO) => {
    if (!dateISO) return "";
    const [y,m,d] = dateISO.split("-").map(Number);
    return `${pad2(d)}-${MON[m-1]}-${y}`;
  };

  const fmtMonthPL = (monthYM) => {
    const [Y, M] = monthYM.split("-").map(Number);
    const dt = new Date(Y, M-1, 1);
    const s = new Intl.DateTimeFormat("pl-PL", { month:"long", year:"numeric" }).format(dt);
    return s.charAt(0).toUpperCase() + s.slice(1);
  };

  const fmtWeekdayPL = (dateISO) => {
    const [Y, M, D] = dateISO.split("-").map(Number);
    const dt = new Date(Y, M-1, D);
    const s = new Intl.DateTimeFormat("pl-PL", { weekday:"long" }).format(dt);
    return s.charAt(0).toUpperCase() + s.slice(1);
  };

  const STORAGE_KEY = "worktime_pwa_v1";
  let db = load() || { settings:{ rate:40 }, entries:[] };

  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
  function load(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch { return null; } }

  // migracja: {date,start,end,note} => {date, shifts:[{start,end}], note}
  function migrateIfNeeded(){
    let changed = false;
    db.entries = (Array.isArray(db.entries) ? db.entries : []).map(e=>{
      if (!e) return e;
      if (Array.isArray(e.shifts)) return e;
      const shifts = [];
      if (e.start && e.end) shifts.push({ start:e.start, end:e.end });
      const ne = { date:e.date, note:e.note || "", shifts };
      changed = true;
      return ne;
    });
    if (changed) save();
  }

  function normalize(){
    db.settings = db.settings || {};
    db.settings.rate = Number(db.settings.rate ?? 40);
    db.entries = Array.isArray(db.entries) ? db.entries : [];
    for (const e of db.entries){
      e.shifts = Array.isArray(e.shifts) ? e.shifts : [];
      e.note = e.note || "";
    }
  }

  function setStatus(t){ const el = $("status"); if (el) el.textContent = t || ""; }

  function minutesBetween(dateISO, start, end) {
    const [y,m,d] = dateISO.split("-").map(Number);
    const [sh,sm] = start.split(":").map(Number);
    const [eh,em] = end.split(":").map(Number);
    const a = new Date(y,m-1,d,sh,sm,0,0);
    let b = new Date(y,m-1,d,eh,em,0,0);
    if (b < a) b = new Date(y,m-1,d+1,eh,em,0,0);
    return Math.round((b-a)/60000);
  }

  function fmtHM(mins){
    const h = Math.floor(mins/60);
    const m = mins%60;
    return `${h}:${pad2(m)}`;
  }
  function pln(x){ return x.toLocaleString("pl-PL",{style:"currency",currency:"PLN"}); }

  function readSettingsFromUI(){ db.settings.rate = Number($("rate").value || 0); }
  function hydrateSettingsUI(){ $("rate").value = db.settings.rate; }

  function getDay(date){ return db.entries.find(e => e.date === date) || null; }

  function upsertDay(date, patch){
    const i = db.entries.findIndex(e => e.date === date);
    if (i >= 0) db.entries[i] = { ...db.entries[i], ...patch };
    else db.entries.push({ date, note:"", shifts:[], ...patch });
    db.entries.sort((a,b)=>a.date.localeCompare(b.date));
  }

  function deleteDay(dateISO){ db.entries = db.entries.filter(e => e.date !== dateISO); }

  function computeDayMinutes(day){
    let total = 0;
    for (const s of day.shifts){
      if (!s?.start || !s?.end) continue;
      total += Math.max(0, minutesBetween(day.date, s.start, s.end));
    }
    return total;
  }

  function computeMonthMinutes(monthYM){
    const days = db.entries.filter(e => ym(e.date) === monthYM);
    return days.reduce((acc, d)=> acc + computeDayMinutes(d), 0);
  }

  // ===== KALENDARZ =====
  const DOW = ["Pn","Wt","Śr","Czw","Pt","Sb","Nd"];
  function mondayIndex(jsDay){ return (jsDay + 6) % 7; }
  function daysInMonth(year, month1){ return new Date(year, month1, 0).getDate(); }

  function renderDow(){
    $("dowRow").innerHTML = DOW.map(d => `<div class="calDow">${d}</div>`).join("");
  }

  function renderCalendar(monthYM){
    $("monthLabelText").textContent = fmtMonthPL(monthYM);

    const [Y, M] = monthYM.split("-").map(Number);
    const first = new Date(Y, M-1, 1);
    const firstIdx = mondayIndex(first.getDay());
    const dim = daysInMonth(Y, M);

    const cells = [];

    for (let i=0;i<firstIdx;i++){
      cells.push(`<div class="blankCell"></div>`);
    }

    for (let d=1; d<=dim; d++){
      const dateISO = `${Y}-${pad2(M)}-${pad2(d)}`;
      const jsDow = new Date(Y, M-1, d).getDay();
      const isWeekend = (jsDow === 0 || jsDow === 6);

      const day = getDay(dateISO);
      const shiftsCount = (day?.shifts || []).length;
      const hasShifts = shiftsCount > 0;
      const hasNote = !!(day?.note && day.note.trim());

      const numClass = [
        "dayNum",
        isWeekend ? "weekend" : "",
        hasShifts ? "has" : ""
      ].filter(Boolean).join(" ");

      cells.push(`
        <div class="dayCell" data-date="${dateISO}">
          <div class="dayTop">
            <div class="${numClass}">${d}</div>
          </div>
          <div class="indRow" aria-hidden="true">
            <span class="dot shift ${hasShifts ? "" : "hidden"}" title="${hasShifts ? "Są godziny" : ""}"></span>
            <span class="dot note ${hasNote ? "" : "hidden"}" title="${hasNote ? "Jest notatka" : ""}"></span>
          </div>
        </div>
      `);
    }

    const mod = cells.length % 7;
    if (mod !== 0){
      const need = 7 - mod;
      for (let i=0;i<need;i++) cells.push(`<div class="blankCell"></div>`);
    }

    $("calGrid").innerHTML = cells.join("");

    document.querySelectorAll(".dayCell[data-date]").forEach(el=>{
      el.onclick = ()=>{
        const date = el.getAttribute("data-date");
        openDay(date);
      };
    });
  }

  // ===== MODAL DNIA =====
  const dlg = $("dayDialog");
  let dlgDate = null;

  function openDay(dateISO){
    dlgDate = dateISO;
    $("date").value = dateISO;

    const weekday = fmtWeekdayPL(dateISO);
    $("dlgTitle").textContent = `${fmtDMYText(dateISO)}`;
    $("dlgMeta").textContent = weekday;

    const day = getDay(dateISO) || { date: dateISO, note:"", shifts:[] };
    $("dlgStart").value = "";
    $("dlgEnd").value = "";
    $("dlgNote").value = day.note || "";

    renderDayDialog();

    if (dlg && typeof dlg.showModal === "function") dlg.showModal();
    else if (dlg) dlg.setAttribute("open","");
  }

  function closeDay(){
    dlgDate = null;
    if (dlg && typeof dlg.close === "function") dlg.close();
    else if (dlg) dlg.removeAttribute("open");
  }

  function renderDayDialog(){
    const day = getDay(dlgDate) || { date: dlgDate, note:"", shifts:[] };
    const mins = computeDayMinutes(day);
    const pay = (mins/60) * (db.settings.rate||0);

    $("dlgSumHM").textContent = fmtHM(mins);
    $("dlgSumPay").textContent = pln(pay);
    $("dlgSummary").textContent = `Zakresy: ${day.shifts.length || 0}`;

    const items = (day.shifts || []).map((s, idx)=>{
      const a = s.start || "—";
      const b = s.end || "—";
      const m = (s.start && s.end) ? Math.max(0, minutesBetween(day.date, s.start, s.end)) : 0;

      return `
        <div class="shiftItem">
          <div>
            <div class="times">${a} – ${b}</div>
            <div class="mins">${m ? ("Czas: " + fmtHM(m)) : "-"}</div>
          </div>
          <button class="miniBtn danger" data-delshift="${idx}">Usuń zakres</button>
        </div>
      `;
    }).join("");

    $("dlgShifts").innerHTML = items || `<div class="muted">Brak zakresów. Dodaj pierwszy powyżej.</div>`;

    document.querySelectorAll("[data-delshift]").forEach(btn=>{
      btn.onclick = ()=>{
        const idx = Number(btn.getAttribute("data-delshift"));
        if (!confirm("Usunąć ten zakres?")) return;
        const d = getDay(dlgDate);
        if (!d) return;
        d.shifts.splice(idx, 1);
        save();
        renderAll();
        renderDayDialog();
      };
    });
  }

  // ===== TOTALS =====
  function renderTotals(monthYM){
    const sumMin = computeMonthMinutes(monthYM);
    $("sumHours").textContent = fmtHM(sumMin);
    $("sumPay").textContent = pln((sumMin/60) * (db.settings.rate||0));
  }

  function renderAll(){
    normalize();
    readSettingsFromUI();
    save();

    const monthYM = $("monthPick").value || ym(todayISO());
    renderDow();
    renderCalendar(monthYM);
    renderTotals(monthYM);
  }

  // ===== EVENTY UI =====
  $("addShiftBtn").onclick = ()=>{
    const date = $("date").value;
    const start = $("start").value;
    const end = $("end").value;
    const note = ($("note").value || "").trim();

    if (!date) return alert("Wybierz datę.");
    if ((start && !end) || (!start && end)) return alert("Uzupełnij wejście i wyjście (albo zostaw oba puste).");
    if (!start && !end && !note) return alert("Wpisz godziny lub notatkę.");

    const day = getDay(date) || { date, note:"", shifts:[] };

    let msg = [];
    if (start && end){
      day.shifts.push({ start, end });
      msg.push("Dodano zakres.");
      $("start").value = "";
      $("end").value = "";
    }
    if (note){
      day.note = note;
      msg.push("Zapisano notatkę.");
    }

    upsertDay(date, day);
    setStatus(msg.join(" ") || "Zapisano.");
    save();
    renderAll();
  };

  $("openDayBtn").onclick = ()=>{
    const date = $("date").value;
    if (!date) return alert("Wybierz datę.");
    openDay(date);
  };

  $("dlgClose").onclick = closeDay;
  if (dlg) dlg.addEventListener("cancel", (e)=>{ e.preventDefault(); closeDay(); });

  $("dlgAddShift").onclick = ()=>{
    if (!dlgDate) return;
    const start = $("dlgStart").value;
    const end = $("dlgEnd").value;
    if (!start || !end) return alert("Uzupełnij wejście i wyjście.");

    const day = getDay(dlgDate) || { date: dlgDate, note:"", shifts:[] };
    day.shifts.push({ start, end });
    upsertDay(dlgDate, day);

    $("dlgStart").value = "";
    $("dlgEnd").value = "";
    save();
    renderAll();
    renderDayDialog();
  };

  $("dlgSaveNote").onclick = ()=>{
    if (!dlgDate) return;
    const note = ($("dlgNote").value || "").trim();
    const day = getDay(dlgDate) || (getDay(dlgDate) || { date: dlgDate, note:"", shifts:[] });
    day.note = note;
    upsertDay(dlgDate, day);
    save();
    renderAll();
    renderDayDialog();
    setStatus("Zapisano notatkę.");
  };

  $("dlgDeleteDay").onclick = ()=>{
    if (!dlgDate) return;
    if (!confirm("Usunąć cały dzień (wszystkie zakresy i notatkę)?")) return;
    deleteDay(dlgDate);
    save();
    closeDay();
    renderAll();
  };

  // miesiąc
  $("monthBar").onclick = ()=>{
    const input = $("monthPick");
    if (!input) return;
    if (typeof input.showPicker === "function") input.showPicker();
    else input.focus();
  };
  $("monthPick").addEventListener("change", renderAll);

  // narzędzia
  $("printPdfBtn").onclick = ()=> window.print();

  $("backupJson").onclick = ()=>{
    const blob = new Blob([JSON.stringify(db,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `czas-pracy-backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  $("restoreBtn").onclick = ()=> $("restoreJson").click();
  $("restoreJson").onchange = async (ev)=>{
    const f = ev.target.files?.[0];
    if (!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      db = obj;
      normalize();
      migrateIfNeeded();
      save();
      hydrateSettingsUI();
      renderAll();
      setStatus("Przywrócono dane z pliku JSON.");
    }catch{
      alert("Nie udało się wczytać pliku JSON.");
    }
  };

  $("clearMonth").onclick = ()=>{
    const monthYM = $("monthPick").value || ym(todayISO());
    if (!confirm("Usunąć wszystkie wpisy z tego miesiąca?")) return;
    db.entries = db.entries.filter(e => ym(e.date) !== monthYM);
    save();
    renderAll();
  };

  ["rate"].forEach(id=>{
    $(id).addEventListener("input", renderAll);
    $(id).addEventListener("change", renderAll);
  });

  // INIT
  try{
    normalize();
    migrateIfNeeded();
    hydrateSettingsUI();
    $("date").value = todayISO();
    $("monthPick").value = ym(todayISO());
    renderAll();
  } catch(err){
    const msg = (err && err.message) ? err.message : String(err);
    const el = document.getElementById("status");
    if (el) el.textContent = "BŁĄD INIT: " + msg;
  }
})();
</script>
</body>
</html>
