<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Czas pracy</title>
  <meta name="theme-color" content="#f6f7fb" />
  <meta name="color-scheme" content="light">
  <link rel="manifest" href="/czas-pracy-pwa/manifest.webmanifest">

  <style>
    *{box-sizing:border-box}

    :root{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;

      --bg:#f6f7fb;
      --surface:#ffffff;
      --surface-soft:rgba(255,255,255,.7);
      --outline-soft:rgba(17,17,17,.08);

      --primary:#50827C;
      --primary-soft:rgba(80,130,124,.12);

      --danger:#d92d20;
      --danger-soft:rgba(217,45,32,.12);

      --sat:rgba(60,64,67,.65);
      --sun:#d93025;
      --holiday:#d93025;

      --bar-work:#1e8e3e;
      --bar-note:#f9ab00;
      --bar-vac:#1a73e8;

      /* tła modali */
      --vac-bg:rgba(26,115,232,.12);
      --bulk-bg:rgba(80,130,124,.14);

      --radius-lg:20px;
      --radius-md:16px;
      --radius-sm:12px;
    }

    html,body{ width:100%; overflow-x:hidden; }
    body{ margin:0; background:var(--bg); color:#111; }

    .wrap{
      max-width:980px;
      margin:18px auto;
      padding:0 14px 90px;
    }

    .section{
      border-bottom:1px solid var(--outline-soft);
      padding-bottom:14px;
      margin-bottom:14px;
    }
    .section:last-of-type{ border-bottom:none; padding-bottom:0; margin-bottom:0; }

    .appHeader{ text-align:center; margin:14px 0 8px; }
    .appHeader h1{ font-size:22px; font-weight:800; margin:0; }
    .appHeader .emoji{ margin-left:6px; opacity:.75; }

    label{
      display:block;
      font-size:12px;
      color:rgba(17,17,17,.65);
      margin-bottom:6px;
    }
    .muted{ font-size:12.5px; color:rgba(17,17,17,.6); }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .twoCols{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }

    input,textarea,select{
      width:100%;
      padding:12px 14px;
      border-radius:var(--radius-lg);
      border:1px solid var(--outline-soft);
      background:var(--surface-soft);
      font-size:14px;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    textarea{ min-height:44px; resize:vertical; }
    input:focus-visible,
    textarea:focus-visible,
    select:focus-visible{
      border-color:var(--primary);
      box-shadow:0 0 0 4px var(--primary-soft);
    }

    button{
      padding:12px 16px;
      border-radius:var(--radius-lg);
      border:none;
      font-size:15px;
      font-weight:500;
      background:var(--primary);
      color:#fff;
      cursor:pointer;
      transition:filter .15s ease, transform .08s ease;
    }
    button.secondary{ background:var(--primary-soft); color:#0f2f2b; }
    button.danger{ background:var(--danger-soft); color:#7a1410; }
    button:active{ transform:scale(.98); }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .chev{
      width:18px; height:18px;
      display:inline-flex;
      align-items:center; justify-content:center;
      opacity:.6;
      transition:transform .18s ease;
    }
    .chev::before{
      content:"";
      width:8px; height:8px;
      border-right:2px solid #111;
      border-bottom:2px solid #111;
      transform:rotate(45deg);
    }
    details[open] .chev{ transform:rotate(180deg); }
    details summary{
      cursor:pointer;
      font-weight:600;
      display:flex;
      justify-content:space-between;
      align-items:center;
      list-style:none;
      padding:10px 0;
    }
    details summary::-webkit-details-marker{display:none}
    .panel{ margin-top:10px; animation:panelIn .18s ease; }
    @keyframes panelIn{ from{opacity:.4; transform:translateY(-4px)} to{opacity:1; transform:translateY(0)} }

    .topMonthBar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 0 2px;
    }
    .monthTitle{ font-size:18px; font-weight:800; line-height:1.1; }
    .monthActions{ display:flex; gap:8px; align-items:center; position:relative; }

    .chip{
      border:1px solid var(--outline-soft);
      background:var(--surface-soft);
      padding:8px 12px;
      border-radius:999px;
      font-weight:600;
      font-size:13px;
      color:#111;
      cursor:pointer;
    }
    .chip:active{ transform:scale(.98); }

    .iconCircle{
      width:42px; height:42px;
      border-radius:999px;
      border:1px solid var(--outline-soft);
      background:var(--surface-soft);
      cursor:pointer;
      display:grid;
      place-items:center;
      position:relative;
    }
    .iconCircle svg{ width:20px; height:20px; opacity:.85; }
    #monthPick{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
      appearance:none;
      -webkit-appearance:none;
    }

    /* KALENDARZ */
    .calGrid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:8px;
    }
    .calDow{
      text-align:center;
      font-size:12px;
      color:rgba(17,17,17,.55);
      padding:2px 0;
    }

    .dayCell{
      border-radius:16px;
      border:1px solid var(--outline-soft);
      background:var(--surface-soft);
      padding:4px 10px 10px;
      cursor:pointer;
      position:relative;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:stretch;
    }
    .blankCell{
      border:none;
      background:transparent;
      box-shadow:none;
      pointer-events:none;
    }
    .dayTop{
      width:100%;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    .dayNum{
      width:100%;
      text-align:center;
      font-size:16px;
      font-weight:750;
      line-height:1.05;
      margin-top:2px;
    }
    .dayNum.saturday{ color:var(--sat); font-weight:650; }
    .dayNum.sunday{ color:var(--sun); }
    .dayNum.holiday{ color:var(--holiday); }
    .dayNum.saturday.holiday{ color:var(--holiday); font-weight:750; }

    .dayCell.today{
      border-color:rgba(26,115,232,.35);
      box-shadow:0 0 0 3px rgba(26,115,232,.12);
      background:rgba(255,255,255,.85);
    }

    .indRow{
      position:absolute;
      left:0; right:0;
      bottom:10px;
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
      pointer-events:none;
    }
    .bar{ display:block; height:4px; width:64%; border-radius:999px; }
    .bar.shift{ background:var(--bar-work); }
    .bar.note{ background:var(--bar-note); }
    .bar.vacation{ background:var(--bar-vac); }
    .bar.hidden{ display:none; }

    @media(max-width:420px){
      .indRow{ bottom:8px; gap:3px; }
      .bar{ height:3px; width:66%; }
    }

    .dayCell, .blankCell{ aspect-ratio: 1 / 1.15; min-height:0; }
    @media (min-width:520px){ .dayCell, .blankCell{ aspect-ratio: 1 / 1.05; } }
    @media (min-width:900px){ .dayCell, .blankCell{ aspect-ratio: 1 / 1; min-height:74px; } }
    @supports not (aspect-ratio: 1 / 1){ .dayCell, .blankCell{ min-height:74px; } }

    .statBox{
      background:var(--primary-soft);
      border-radius:16px;
      padding:12px 14px;
    }
    .statValue{ font-size:22px; font-weight:900; margin-top:4px; }

    /* ===== MODAL DNIA (pełny ekran) ===== */
    dialog#dayDialog{
      border:none;
      padding:0;
      width:100vw;
      height:100dvh;
      max-width:100vw;
      max-height:100dvh;
      margin:0;
      border-radius:0;
      box-shadow:0 18px 60px rgba(0,0,0,.25);
      overflow:hidden;
    }
    dialog#dayDialog::backdrop{ background:rgba(17,17,17,.45); }

    /* ===== MODALE PŁYWAJĄCE ===== */
    dialog#vacDialog,
    dialog#bulkDialog{
      border:none;
      padding:0;
      width:min(560px, calc(100vw - 28px));
      max-width:560px;
      margin:auto;
      border-radius:22px;
      box-shadow:0 18px 60px rgba(0,0,0,.25);
      overflow:hidden;
    }
    dialog#vacDialog::backdrop,
    dialog#bulkDialog::backdrop{ background:rgba(17,17,17,.45); }

    .modalHead{
      background:var(--bg);
      padding:16px 16px 14px;
      border-bottom:1px solid var(--outline-soft);
      position:sticky;
      top:0;
      z-index:2;
    }
    .modalBody{
      padding:16px;
      background:var(--bg);
    }

    /* tła dla modali */
    #vacDialog .modalBody{ background:var(--vac-bg); }
    #bulkDialog .modalBody{ background:var(--bulk-bg); }

    /* back button (wspólne) */
    .backBtn{
      width:44px;
      height:44px;
      padding:0;
      border-radius:18px;
      border:1px solid var(--outline-soft);
      background:var(--primary);
      color:#fff;
      cursor:pointer;
      display:grid;
      place-items:center;
      position:absolute;
      top:10px;
      right:12px;
      left:auto;
    }
    .backBtn.blue{
      background:var(--bar-vac);
      border:1px solid rgba(26,115,232,.18);
    }
    .backBtn svg{ width:20px; height:20px; opacity:.92; }

    .modalHeadInner{ padding-right:58px; }

    .modalStats{
      display:flex;
      justify-content:space-between;
      align-items:stretch;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:nowrap;
    }
    .statMini{
      flex:1;
      min-width:0;
      background:var(--primary-soft);
      border-radius:16px;
      padding:12px 14px;
    }
    .statMiniValue{
      font-size:20px;
      font-weight:900;
      margin-top:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    @media(max-width:380px){ .statMiniValue{ font-size:18px; } }

    .modalStack{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .timeGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media(max-width:520px){
      .timeGrid{ grid-template-columns:1fr 1fr; gap:10px; }
    }
    .addBtnCenter{
      width:min(320px, 100%);
      margin:4px auto 0;
      display:block;
    }

    .shiftList{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:10px;
    }
    .shiftItem{
      border:none;
      background:var(--primary-soft);
      border-radius:16px;
      padding:12px 12px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .shiftItem .times{ font-weight:650; font-size:16px; }
    .shiftItem .mins{
      font-size:12.5px;
      color:rgba(17,17,17,.6);
      margin-top:4px;
    }

    .delIcon{
      width:36px;
      height:36px;
      border-radius:18px;
      border:1px solid rgba(217,45,32,.22);
      background:rgba(217,45,32,.10);
      cursor:pointer;
      position:relative;
      flex:0 0 auto;
    }
    .delIcon::before,.delIcon::after{
      content:"";
      position:absolute;
      top:50%;
      left:50%;
      width:14px;
      height:2px;
      background:#7a1410;
      border-radius:2px;
      transform-origin:center;
    }
    .delIcon::before{ transform:translate(-50%,-50%) rotate(45deg); }
    .delIcon::after{ transform:translate(-50%,-50%) rotate(-45deg); }

    body.modal-open{
      overflow:hidden;
      height:100vh;
      touch-action:none;
    }

    /* Przyciski pod kalendarzem */
    .bulkBtn{
      width:100%;
      background:rgba(80,130,124,.14);
      border:1px solid rgba(80,130,124,.18);
      color:#0f2f2b;
      font-weight:900;
    }
    .vacBtn{
      width:100%;
      background:rgba(26,115,232,.12);
      border:1px solid rgba(26,115,232,.18);
      color:#0b2d64;
      font-weight:900;
    }

    /* Układ w modalach: od/do obok siebie + bez ramek wokół */
    .rangeRow{
      display:flex;
      gap:10px;
      flex-wrap:nowrap;
      align-items:flex-end;
    }
    .rangeRow > *{ flex:1; min-width:0; }
    @media(max-width:380px){
      .rangeRow{ flex-wrap:wrap; }
      .rangeRow > *{ min-width:160px; }
    }

    .actionRow{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .actionRow > *{ flex:1; }

    /* FAB */
    .fab{
      position:fixed;
      right:16px;
      bottom:16px;
      width:56px;
      height:56px;
      border-radius:18px;
      border:none;
      background:var(--primary);
      color:#fff;
      cursor:pointer;
      display:grid;
      place-items:center;
      z-index:999;
    }
    .fab:active{ transform:scale(.98); }
    .fab svg{ width:22px;height:22px; }

    *{-webkit-tap-highlight-color:transparent}
    :focus{outline:none}
    :focus-visible{
      outline:2px solid var(--primary);
      outline-offset:2px;
      border-radius:12px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="appHeader">
      <h1>Czas pracy <span class="emoji">⏱️</span></h1>
    </header>

    <div class="section">
      <div class="topMonthBar">
        <div class="monthTitle" id="monthLabelText">—</div>

        <div class="monthActions">
          <button class="chip" id="todayBtn" type="button">Dzisiaj</button>

          <div class="iconCircle" id="monthBar" title="Wybierz miesiąc" aria-label="Wybierz miesiąc">
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
              <path fill="currentColor" d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a3 3 0 0 1 3 3v13a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h1V3a1 1 0 0 1 1-1Zm12 8H5v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V10ZM6 6a1 1 0 0 0-1 1v1h14V7a1 1 0 0 0-1-1H6Z"/>
            </svg>
            <input id="monthPick" type="month" aria-label="Wybierz miesiąc" />
          </div>
        </div>
      </div>

      <div class="twoCols" style="margin-top:12px;">
        <div class="statBox">
          <div class="muted">Suma godzin w miesiącu</div>
          <div class="statValue" id="sumHours">0:00</div>
        </div>
        <div class="statBox">
          <div class="muted">Wypłata</div>
          <div class="statValue" id="sumPay">0,00 zł</div>
        </div>
      </div>

      <div class="muted" id="status" style="margin-top:10px;"></div>
    </div>

    <!-- KALENDARZ (to wraca i nie może zniknąć) -->
    <div class="section">
      <div class="calGrid" id="dowRow" style="margin-bottom:6px;"></div>
      <div class="calGrid" id="calGrid"></div>

      <div class="row" style="margin-top:14px;">
        <button class="bulkBtn" id="openBulkDialog" type="button">Dodaj wiele godzin</button>
      </div>
      <div class="row" style="margin-top:10px;">
        <button class="vacBtn" id="openVacDialog" type="button">Dodaj urlop</button>
      </div>
    </div>

    <div class="section">
      <details id="extrasPanel">
        <summary>
          <span>Ustawienia pracodawcy</span>
          <span class="chev" aria-hidden="true"></span>
        </summary>
        <div class="panel">
          <div class="row" style="margin-top:12px;">
            <div style="flex:1; min-width:240px;">
              <label>Stawka godzinowa (PLN)</label>
              <input id="rate" type="number" step="0.01" min="0" value="40" />
            </div>
          </div>
        </div>
      </details>
    </div>

    <div class="section">
      <details id="toolsPanel">
        <summary>
          <span>Narzędzia</span>
          <span class="chev" aria-hidden="true"></span>
        </summary>
        <div class="panel">
          <div class="row" style="margin-top:12px;">
            <button class="secondary" id="reportPdf" type="button" style="flex:1; min-width:180px;">Raport PDF</button>

            <button class="danger" id="clearMonth" type="button" style="flex:1; min-width:240px;">Usuń cały miesiąc</button>
            <button class="secondary" id="backupJson" type="button" style="flex:1; min-width:180px;">Kopia zapasowa</button>

            <input id="restoreJson" type="file" accept="application/json" style="display:none" />
            <button class="secondary" id="restoreBtn" type="button" style="flex:1; min-width:180px;">Przywróć kopię zapasową</button>
          </div>
        </div>
      </details>
    </div>
  </div>

  <!-- FAB -->
  <button class="fab" id="fabAdd" aria-label="Dodaj godziny (dzisiaj)" title="Dodaj (dzisiaj)" type="button">
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path fill="currentColor" d="M11 5a1 1 0 0 1 2 0v6h6a1 1 0 1 1 0 2h-6v6a1 1 0 1 1-2 0v-6H5a1 1 0 1 1 0-2h6V5z"/>
    </svg>
  </button>

  <!-- MODAL URLOPU (pływający) -->
  <dialog id="vacDialog">
    <div class="modalHead" style="position:relative;">
      <div class="modalHeadInner">
        <h3 style="margin:0;">Dodaj urlop</h3>
        <div class="muted" style="margin-top:3px;">Po ustawieniu urlopu dni w kalendarzu oznaczą się na niebiesko.</div>
      </div>

      <button class="backBtn blue" id="vacBack" aria-label="Zamknij" type="button" title="Zamknij">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path fill="currentColor" d="M14.7 6.3a1 1 0 0 1 0 1.4L10.41 12l4.3 4.3a1 1 0 1 1-1.42 1.4l-5-5a1 1 0 0 1 0-1.4l5-5a1 1 0 0 1 1.41 0Z"/>
        </svg>
      </button>
    </div>

    <div class="modalBody">
      <div class="rangeRow">
        <div>
          <label>Od</label>
          <input id="vacFrom" type="date" />
        </div>
        <div>
          <label>Do</label>
          <input id="vacTo" type="date" />
        </div>
      </div>

      <div class="actionRow">
        <button id="setVacationRange" type="button" style="background:var(--bar-vac); font-weight:900;">Dodaj</button>
        <button class="danger" id="clearVacationRange" type="button" style="font-weight:900;">Usuń</button>
      </div>

      <div style="height:6px;"></div>
    </div>
  </dialog>

  <!-- MODAL WIELE GODZIN (pływający) -->
  <dialog id="bulkDialog">
    <div class="modalHead" style="position:relative;">
      <div class="modalHeadInner">
        <h3 style="margin:0;">Dodaj wiele godzin</h3>
        <div class="muted" style="margin-top:3px;">Ustaw zakres dat i jedną parę wejścia/wyjścia dla wszystkich dni (dni z urlopem są pomijane).</div>
      </div>

      <button class="backBtn" id="bulkBack" aria-label="Zamknij" type="button" title="Zamknij">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path fill="currentColor" d="M14.7 6.3a1 1 0 0 1 0 1.4L10.41 12l4.3 4.3a1 1 0 1 1-1.42 1.4l-5-5a1 1 0 0 1 0-1.4l5-5a1 1 0 0 1 1.41 0Z"/>
        </svg>
      </button>
    </div>

    <div class="modalBody">
      <div class="rangeRow">
        <div>
          <label>Od</label>
          <input id="bulkFrom" type="date" />
        </div>
        <div>
          <label>Do</label>
          <input id="bulkTo" type="date" />
        </div>
      </div>

      <div class="timeGrid" style="margin-top:12px;">
        <div>
          <label>Godzina wejścia</label>
          <input id="bulkStart" type="time" />
        </div>
        <div>
          <label>Godzina wyjścia</label>
          <input id="bulkEnd" type="time" />
        </div>
      </div>

      <div class="actionRow">
        <button id="bulkApply" type="button" style="background:var(--primary); font-weight:900;">Dodaj</button>
        <button id="bulkRemove" type="button" class="danger" style="font-weight:900;">Usuń godziny</button>
      </div>

      <div class="muted" style="margin-top:10px; line-height:1.35;">
        Uwaga: „Dodaj” dopisuje zakres do każdego dnia (nie nadpisuje istniejących). „Usuń godziny” usuwa w tych dniach dokładnie ten sam zakres (jeśli istnieje).
      </div>

      <div style="height:6px;"></div>
    </div>
  </dialog>

  <!-- MODAL DNIA (pełny ekran) -->
  <dialog id="dayDialog">
    <div class="modalHead" style="position:relative;">
      <div class="modalHeadInner">
        <h3 id="dlgTitle" style="margin:0;">Dzień</h3>
        <div class="muted" id="dlgMeta" style="margin-top:3px;"></div>
      </div>

      <button class="backBtn" id="dlgBack" aria-label="Wróć" type="button" title="Wróć">
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path fill="currentColor" d="M14.7 6.3a1 1 0 0 1 0 1.4L10.41 12l4.3 4.3a1 1 0 1 1-1.42 1.4l-5-5a1 1 0 0 1 0-1.4l5-5a1 1 0 0 1 1.41 0Z"/>
        </svg>
      </button>
    </div>

    <div class="modalBody">
      <div class="modalStats">
        <div class="statMini">
          <div class="muted">Suma godzin</div>
          <div class="statMiniValue" id="dlgSumHM">0:00</div>
        </div>
        <div class="statMini">
          <div class="muted">Dniówka</div>
          <div class="statMiniValue" id="dlgSumPay">0,00 zł</div>
        </div>
      </div>

      <!-- Blok pracy -->
      <div class="modalStack" id="dlgWorkBlock">
        <div class="timeGrid">
          <div>
            <label>Godzina wejścia</label>
            <input id="dlgStart" type="time" />
          </div>
          <div>
            <label>Godzina wyjścia</label>
            <input id="dlgEnd" type="time" />
          </div>
        </div>

        <div>
          <label>Notatka</label>
          <textarea id="dlgNote"></textarea>
          <div class="muted" style="margin-top:6px;">Notatka zapisuje się automatycznie.</div>
        </div>

        <button id="dlgAddShift" type="button" class="addBtnCenter">Dodaj</button>
      </div>

      <!-- Blok statusu / zakresów -->
      <div style="margin-top:16px;" id="dlgShiftsBlock">
        <strong id="dlgShiftsTitle">Godziny pracy w ciągu dnia</strong>
        <div class="shiftList" id="dlgShifts"></div>

        <button id="dlgRemoveVacation" type="button" class="danger" style="width:100%; margin-top:12px; display:none;">
          Usuń urlop
        </button>
      </div>

      <div style="height:14px;"></div>
    </div>
  </dialog>

  <script>
  (() => {
    const showErr = (msg) => {
      const el = document.getElementById("status");
      if (el) el.textContent = "BŁĄD: " + msg;
    };
    window.addEventListener("error", (e) => showErr(e.message || "Nieznany błąd JS"));
    window.addEventListener("unhandledrejection", (e) => {
      showErr((e.reason && e.reason.message) ? e.reason.message : String(e.reason || "Promise error"));
    });

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/czas-pracy-pwa/sw.js", { scope: "/czas-pracy-pwa/" });
    }

    const $ = (id) => document.getElementById(id);
    const pad2 = (n) => String(n).padStart(2,"0");

    const todayISO = () => {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    };
    const ym = (dateISO) => dateISO.slice(0,7);

    const MON = ["sty","lut","mar","kwi","maj","cze","lip","sie","wrz","paź","lis","gru"];
    const fmtDMYText = (dateISO) => {
      if (!dateISO) return "";
      const [y,m,d] = dateISO.split("-").map(Number);
      return `${pad2(d)}-${MON[m-1]}-${y}`;
    };

    const fmtMonthPL = (monthYM) => {
      const [Y, M] = monthYM.split("-").map(Number);
      const dt = new Date(Y, M-1, 1);
      const s = new Intl.DateTimeFormat("pl-PL", { month:"long", year:"numeric" }).format(dt);
      return s.charAt(0).toUpperCase() + s.slice(1);
    };

    const DOW_SHORT = ["Nd","Pn","Wt","Śr","Czw","Pt","Sb"];
    const fmtWeekdayPL = (dateISO) => {
      const [Y, M, D] = dateISO.split("-").map(Number);
      const dt = new Date(Y, M-1, D);
      return DOW_SHORT[dt.getDay()];
    };

    const STORAGE_KEY = "worktime_pwa_v1";
    let db = load() || { settings:{ rate:40 }, entries:[] };

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
    function load(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch { return null; } }

    function migrateIfNeeded(){
      let changed = false;
      db.entries = (Array.isArray(db.entries) ? db.entries : []).map(e=>{
        if (!e) return e;
        if (Array.isArray(e.shifts)) {
          if (typeof e.vacation !== "boolean"){ e.vacation = false; changed = true; }
          return e;
        }
        const shifts = [];
        if (e.start && e.end) shifts.push({ start:e.start, end:e.end });
        const ne = { date:e.date, note:e.note || "", shifts, vacation:false };
        changed = true;
        return ne;
      });
      if (changed) save();
    }

    function normalize(){
      db.settings = db.settings || {};
      db.settings.rate = Number(db.settings.rate ?? 40);
      db.entries = Array.isArray(db.entries) ? db.entries : [];
      for (const e of db.entries){
        e.shifts = Array.isArray(e.shifts) ? e.shifts : [];
        e.note = e.note || "";
        e.vacation = !!e.vacation;
      }
    }

    function setStatus(t){ const el = $("status"); if (el) el.textContent = t || ""; }

    function minutesBetween(dateISO, start, end) {
      const [y,m,d] = dateISO.split("-").map(Number);
      const [sh,sm] = start.split(":").map(Number);
      const [eh,em] = end.split(":").map(Number);
      const a = new Date(y,m-1,d,sh,sm,0,0);
      let b = new Date(y,m-1,d,eh,em,0,0);
      if (b < a) b = new Date(y,m-1,d+1,eh,em,0,0);
      return Math.round((b-a)/60000);
    }

    function fmtHM(mins){
      const h = Math.floor(mins/60);
      const m = mins%60;
      return `${h}:${pad2(m)}`;
    }
    function pln(x){ return x.toLocaleString("pl-PL",{style:"currency",currency:"PLN"}); }

    function readSettingsFromUI(){
      const rateEl = $("rate");
      if (!rateEl) return;
      db.settings.rate = Number(rateEl.value || 0);
    }
    function hydrateSettingsUI(){
      const rateEl = $("rate");
      if (!rateEl) return;
      rateEl.value = db.settings.rate;
    }

    function getDay(date){ return db.entries.find(e => e.date === date) || null; }

    function upsertDay(date, patch){
      const i = db.entries.findIndex(e => e.date === date);
      if (i >= 0) db.entries[i] = { ...db.entries[i], ...patch };
      else db.entries.push({ date, note:"", shifts:[], vacation:false, ...patch });
      db.entries.sort((a,b)=>a.date.localeCompare(b.date));
    }

    function computeDayMinutes(day){
      if (day.vacation) return 0;
      let total = 0;
      for (const s of day.shifts){
        if (!s?.start || !s?.end) continue;
        total += Math.max(0, minutesBetween(day.date, s.start, s.end));
      }
      return total;
    }

    function computeMonthMinutes(monthYM){
      const days = db.entries.filter(e => ym(e.date) === monthYM);
      return days.reduce((acc, d)=> acc + computeDayMinutes(d), 0);
    }

    // ===== Daty pomocnicze =====
    function parseISODate(s){
      if (!s || !/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
      const [Y,M,D] = s.split("-").map(Number);
      const dt = new Date(Y, M-1, D);
      if (dt.getFullYear() !== Y || dt.getMonth() !== (M-1) || dt.getDate() !== D) return null;
      return dt;
    }
    function isoFromDate(dt){
      return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
    }
    function addDays(dt, n){
      const x = new Date(dt);
      x.setDate(x.getDate() + n);
      return x;
    }

    // ===== Urlop: zakres =====
    function applyVacationRange(fromISO, toISO, enable){
      const a = parseISODate(fromISO);
      const b = parseISODate(toISO);
      if (!a || !b) { alert("Uzupełnij poprawnie daty 'Od' i 'Do'."); return {ok:false}; }
      if (b < a) { alert("Data 'Do' nie może być wcześniejsza niż 'Od'."); return {ok:false}; }

      let cur = a;
      let count = 0;
      while (cur <= b){
        const dISO = isoFromDate(cur);
        const day = getDay(dISO) || { date:dISO, note:"", shifts:[], vacation:false };
        if (enable){
          day.vacation = true;
          day.shifts = [];
        } else {
          day.vacation = false;
        }
        upsertDay(dISO, day);
        count++;
        cur = addDays(cur, 1);
      }
      save();
      renderAll();
      if (dlgDate) renderDayDialog();
      setStatus(enable ? (`Ustawiono urlop: ${count} dni.`) : (`Usunięto urlop: ${count} dni.`));
      return {ok:true, count};
    }

    // ===== Wiele godzin: zakres =====
    function applyBulkHours(fromISO, toISO, start, end, mode){
      const a = parseISODate(fromISO);
      const b = parseISODate(toISO);
      if (!a || !b) { alert("Uzupełnij poprawnie daty 'Od' i 'Do'."); return {ok:false}; }
      if (b < a) { alert("Data 'Do' nie może być wcześniejsza niż 'Od'."); return {ok:false}; }
      if (!start || !end) { alert("Uzupełnij godzinę wejścia i wyjścia."); return {ok:false}; }

      let cur = a;
      let changedDays = 0;

      while (cur <= b){
        const dISO = isoFromDate(cur);
        const day = getDay(dISO) || { date:dISO, note:"", shifts:[], vacation:false };

        // pomijamy urlop
        if (day.vacation){
          cur = addDays(cur, 1);
          continue;
        }

        day.shifts = Array.isArray(day.shifts) ? day.shifts : [];

        if (mode === "add"){
          day.shifts.push({ start, end });
          day.shifts.sort((x,y)=> (x.start||"").localeCompare(y.start||""));
          upsertDay(dISO, day);
          changedDays++;
        }

        if (mode === "remove"){
          const before = day.shifts.length;
          day.shifts = day.shifts.filter(s => !(s && s.start === start && s.end === end));
          if (day.shifts.length !== before){
            upsertDay(dISO, day);
            changedDays++;
          }
        }

        cur = addDays(cur, 1);
      }

      save();
      renderAll();
      if (dlgDate) renderDayDialog();

      setStatus(
        mode === "add"
          ? `Dodano godziny (zakres) w ${changedDays} dniach.`
          : `Usunięto godziny (zakres) w ${changedDays} dniach.`
      );

      return {ok:true, changedDays};
    }

    // ===== ŚWIĘTA PL =====
    function easterSunday(year){
      const a = year % 19;
      const b = Math.floor(year / 100);
      const c = year % 100;
      const d = Math.floor(b / 4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19 * a + b - d - g + 15) % 30;
      const i = Math.floor(c / 4);
      const k = c % 4;
      const l = (32 + 2 * e + 2 * i - h - k) % 7;
      const m = Math.floor((a + 11 * h + 22 * l) / 451);
      const month = Math.floor((h + l - 7 * m + 114) / 31);
      const day = ((h + l - 7 * m + 114) % 31) + 1;
      return new Date(year, month - 1, day);
    }

    function polishHolidays(year){
      const map = new Map();
      map.set(`${year}-01-01`, "Nowy Rok");
      map.set(`${year}-01-06`, "Święto Trzech Króli");
      map.set(`${year}-05-01`, "Święto Pracy");
      map.set(`${year}-05-03`, "Święto Konstytucji 3 Maja");
      map.set(`${year}-08-15`, "Wniebowzięcie NMP");
      map.set(`${year}-11-01`, "Wszystkich Świętych");
      map.set(`${year}-11-11`, "Narodowe Święto Niepodległości");
      map.set(`${year}-12-24`, "Wigilia");
      map.set(`${year}-12-25`, "Boże Narodzenie (1. dzień)");
      map.set(`${year}-12-26`, "Boże Narodzenie (2. dzień)");

      const easter = easterSunday(year);
      map.set(isoFromDate(easter), "Wielkanoc");
      map.set(isoFromDate(addDays(easter, 1)), "Poniedziałek Wielkanocny");
      map.set(isoFromDate(addDays(easter, 49)), "Zielone Świątki");
      map.set(isoFromDate(addDays(easter, 60)), "Boże Ciało");

      return map;
    }

    const holidayCache = new Map();
    function getHolidayMap(year){
      if (!holidayCache.has(year)) holidayCache.set(year, polishHolidays(year));
      return holidayCache.get(year);
    }

    // ===== KALENDARZ =====
    const DOW = ["Pn","Wt","Śr","Czw","Pt","Sb","Nd"];
    function mondayIndex(jsDay){ return (jsDay + 6) % 7; }
    function daysInMonth(year, month1){ return new Date(year, month1, 0).getDate(); }

    let shouldScrollToToday = false;

    function renderDow(){
      const dowRow = $("dowRow");
      if (!dowRow) return;
      dowRow.innerHTML = DOW.map(d => `<div class="calDow">${d}</div>`).join("");
    }

    function renderCalendar(monthYM){
      const monthLabel = $("monthLabelText");
      const calGrid = $("calGrid");
      if (!monthLabel || !calGrid) return;

      monthLabel.textContent = fmtMonthPL(monthYM);

      const [Y, M] = monthYM.split("-").map(Number);
      const first = new Date(Y, M-1, 1);
      const firstIdx = mondayIndex(first.getDay());
      const dim = daysInMonth(Y, M);

      const holidays = getHolidayMap(Y);
      const cells = [];
      const today = todayISO();

      for (let i=0;i<firstIdx;i++) cells.push(`<div class="blankCell"></div>`);

      for (let d=1; d<=dim; d++){
        const dateISO = `${Y}-${pad2(M)}-${pad2(d)}`;
        const jsDow = new Date(Y, M-1, d).getDay();

        const day = getDay(dateISO);
        const isVacation = !!day?.vacation;
        const hasShifts = !isVacation && ((day?.shifts || []).length > 0);
        const hasNote = !!(day?.note && day.note.trim());

        const holidayName = holidays.get(dateISO) || "";
        const isHoliday = !!holidayName;

        const numClass = [
          "dayNum",
          jsDow === 6 ? "saturday" : "",
          jsDow === 0 ? "sunday" : "",
          isHoliday ? "holiday" : ""
        ].filter(Boolean).join(" ");

        const tileTitle = isVacation ? "Urlop" : (isHoliday ? holidayName : "");
        const isToday = (dateISO === today);
        const dayCellClass = ["dayCell", isToday ? "today" : ""].filter(Boolean).join(" ");

        cells.push(`
          <div class="${dayCellClass}" data-date="${dateISO}" ${tileTitle ? `title="${tileTitle}"` : ""}>
            <div class="dayTop">
              <div class="${numClass}">${d}</div>
            </div>
            <div class="indRow" aria-hidden="true">
              <span class="bar vacation ${isVacation ? "" : "hidden"}"></span>
              <span class="bar shift ${hasShifts ? "" : "hidden"}"></span>
              <span class="bar note ${hasNote ? "" : "hidden"}"></span>
            </div>
          </div>
        `);
      }

      const mod = cells.length % 7;
      if (mod !== 0){
        const need = 7 - mod;
        for (let i=0;i<need;i++) cells.push(`<div class="blankCell"></div>`);
      }

      calGrid.innerHTML = cells.join("");

      document.querySelectorAll(".dayCell[data-date]").forEach(el=>{
        el.onclick = ()=>{
          const date = el.getAttribute("data-date");
          openDay(date);
        };
      });

      if (shouldScrollToToday){
        shouldScrollToToday = false;
        const el = document.querySelector(`.dayCell[data-date="${today}"]`);
        if (el) el.scrollIntoView({behavior:"smooth", block:"center"});
      }
    }

    // ===== MODAL DNIA =====
    const dlg = $("dayDialog");
    let dlgDate = null;

    function openDay(dateISO){
      dlgDate = dateISO;

      const weekday = fmtWeekdayPL(dateISO);
      if ($("dlgTitle")) $("dlgTitle").textContent = `${fmtDMYText(dateISO)}`;
      if ($("dlgMeta")) $("dlgMeta").textContent = weekday;

      const day = getDay(dateISO) || { date: dateISO, note:"", shifts:[], vacation:false };
      if ($("dlgStart")) $("dlgStart").value = "";
      if ($("dlgEnd")) $("dlgEnd").value = "";
      if ($("dlgNote")) $("dlgNote").value = day.note || "";

      renderDayDialog();

      if (dlg && typeof dlg.showModal === "function") dlg.showModal();
      else if (dlg) dlg.setAttribute("open","");
      document.body.classList.add("modal-open");
    }

    function closeDay(){
      dlgDate = null;
      if (dlg && typeof dlg.close === "function") dlg.close();
      else if (dlg) dlg.removeAttribute("open");
      document.body.classList.remove("modal-open");
    }

    if (dlg){
      dlg.addEventListener("close", ()=> document.body.classList.remove("modal-open"));
      dlg.addEventListener("cancel", (e)=>{ e.preventDefault(); closeDay(); });
    }

    function renderDayDialog(){
      if (!dlgDate) return;
      const day = getDay(dlgDate) || { date: dlgDate, note:"", shifts:[], vacation:false };

      const workBlock = $("dlgWorkBlock");
      const shiftsTitle = $("dlgShiftsTitle");
      const shiftsBox = $("dlgShifts");
      const removeVacBtn = $("dlgRemoveVacation");

      if (day.vacation){
        if (workBlock) workBlock.style.display = "none";
        if (shiftsTitle) shiftsTitle.textContent = "Status dnia";
        if (shiftsBox) shiftsBox.innerHTML =
          `<div class="muted" style="font-size:16px; font-weight:900; color:#0b2d64;">Urlop</div>`;
        if (removeVacBtn) removeVacBtn.style.display = "block";

        if ($("dlgSumHM")) $("dlgSumHM").textContent = "0:00";
        if ($("dlgSumPay")) $("dlgSumPay").textContent = pln(0);
        return;
      }

      if (removeVacBtn) removeVacBtn.style.display = "none";
      if (workBlock) workBlock.style.display = "";
      if (shiftsTitle) shiftsTitle.textContent = "Godziny pracy w ciągu dnia";

      day.shifts.sort((a,b)=> (a.start || "").localeCompare(b.start || ""));

      const mins = computeDayMinutes(day);
      const pay = (mins/60) * (db.settings.rate||0);

      if ($("dlgSumHM")) $("dlgSumHM").textContent = fmtHM(mins);
      if ($("dlgSumPay")) $("dlgSumPay").textContent = pln(pay);

      const items = (day.shifts || []).map((s, idx)=>{
        const a = s.start || "—";
        const b = s.end || "—";
        const m = (s.start && s.end) ? Math.max(0, minutesBetween(day.date, s.start, s.end)) : 0;

        return `
          <div class="shiftItem">
            <div>
              <div class="times">${a} – ${b}</div>
              <div class="mins">${m ? ("Ilość godzin: " + fmtHM(m)) : "-"}</div>
            </div>
            <button class="delIcon" data-delshift="${idx}" aria-label="Usuń zakres" type="button"></button>
          </div>
        `;
      }).join("");

      if (shiftsBox){
        shiftsBox.innerHTML = items || `<div class="muted">Brak zakresów. Dodaj pierwszy powyżej.</div>`;
      }

      document.querySelectorAll("[data-delshift]").forEach(btn=>{
        btn.onclick = ()=>{
          const idx = Number(btn.getAttribute("data-delshift"));
          if (!confirm("Usunąć ten zakres?")) return;
          const d = getDay(dlgDate);
          if (!d) return;
          d.shifts.splice(idx, 1);
          save();
          renderAll();
          renderDayDialog();
        };
      });
    }

    // ===== TOTALS =====
    function renderTotals(monthYM){
      const sumMin = computeMonthMinutes(monthYM);
      if ($("sumHours")) $("sumHours").textContent = fmtHM(sumMin);
      if ($("sumPay")) $("sumPay").textContent = pln((sumMin/60) * (db.settings.rate||0));
    }

    function renderAll(){
      normalize();
      readSettingsFromUI();
      save();

      const monthPick = $("monthPick");
      const monthYM = (monthPick && monthPick.value) ? monthPick.value : ym(todayISO());

      renderDow();
      renderCalendar(monthYM);
      renderTotals(monthYM);
    }

    // ===== MODAL URLOPU =====
    const vacDlg = $("vacDialog");
    function openVac(){
      if (!vacDlg) return;
      const t = todayISO();
      if ($("vacFrom") && !$("vacFrom").value) $("vacFrom").value = t;
      if ($("vacTo") && !$("vacTo").value) $("vacTo").value = t;
      if (typeof vacDlg.showModal === "function") vacDlg.showModal();
      else vacDlg.setAttribute("open","");
    }
    function closeVac(){
      if (!vacDlg) return;
      if (typeof vacDlg.close === "function") vacDlg.close();
      else vacDlg.removeAttribute("open");
    }
    if (vacDlg){
      vacDlg.addEventListener("cancel", (e)=>{ e.preventDefault(); closeVac(); });
    }

    // ===== MODAL WIELE GODZIN =====
    const bulkDlg = $("bulkDialog");
    function openBulk(){
      if (!bulkDlg) return;
      const t = todayISO();
      if ($("bulkFrom") && !$("bulkFrom").value) $("bulkFrom").value = t;
      if ($("bulkTo") && !$("bulkTo").value) $("bulkTo").value = t;
      if (typeof bulkDlg.showModal === "function") bulkDlg.showModal();
      else bulkDlg.setAttribute("open","");
    }
    function closeBulk(){
      if (!bulkDlg) return;
      if (typeof bulkDlg.close === "function") bulkDlg.close();
      else bulkDlg.removeAttribute("open");
    }
    if (bulkDlg){
      bulkDlg.addEventListener("cancel", (e)=>{ e.preventDefault(); closeBulk(); });
    }

    // ===== RAPORT PDF (druk do PDF) =====
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function fmtHoursHuman(mins){
      const h = Math.floor(mins/60);
      const m = mins%60;
      if (!m) return `${h} h`;
      return `${h} h ${m} min`;
    }

    function buildReportHTML(monthYM){
      const [Y, M] = monthYM.split("-").map(Number);
      const dim = new Date(Y, M, 0).getDate();

      const monthLabel = fmtMonthPL(monthYM);
      const sumMin = computeMonthMinutes(monthYM);
      const sumPay = (sumMin/60) * (db.settings.rate||0);

      const notes = [];
      const rows = [];

      for (let d=1; d<=dim; d++){
        const dateISO = `${Y}-${pad2(M)}-${pad2(d)}`;
        const dow = fmtWeekdayPL(dateISO);
        const day = getDay(dateISO) || { date:dateISO, note:"", shifts:[], vacation:false };

        const isVacation = !!day.vacation;
        const mins = computeDayMinutes(day);

        const shifts = (day.shifts || []).slice().sort((a,b)=> (a.start||"").localeCompare(b.start||""));
        let ranges = "";
        if (isVacation) ranges = "Urlop";
        else if (shifts.length){
          ranges = shifts
            .map(s => (s?.start && s?.end) ? `${s.start}-${s.end}` : "")
            .filter(Boolean)
            .join(", ");
        }

        const note = (day.note || "").trim();
        const noteShort = note.length > 44 ? (note.slice(0,44) + "…") : note;

        if (note) notes.push({ dateISO, dow, note });

        rows.push(`
          <tr>
            <td class="c-date">${pad2(d)}.${pad2(M)}.${Y}</td>
            <td class="c-dow">${dow}</td>
            <td class="c-ranges">${escapeHtml(ranges)}</td>
            <td class="c-sum">${fmtHM(mins)}</td>
            <td class="c-note">${escapeHtml(noteShort)}</td>
          </tr>
        `);
      }

      const notesHtml = notes.length
        ? notes.map(n => `
            <div class="noteRow">
              <span class="noteDate">${escapeHtml(`${n.dateISO} (${n.dow})`)}</span>
              <span class="noteText">${escapeHtml(n.note)}</span>
            </div>
          `).join("")
        : `<div class="muted">Brak notatek w tym miesiącu.</div>`;

      const gen = new Date();
      const genText = `${gen.getFullYear()}-${pad2(gen.getMonth()+1)}-${pad2(gen.getDate())} ${pad2(gen.getHours())}:${pad2(gen.getMinutes())}`;

      return `<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raport godzin pracy</title>
  <style>
    @page { size: A4; margin: 10mm; }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:#111;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
    }
    .meta{
      font-size:11px;
      line-height:1.35;
      color:#333;
      text-align:right;
      white-space:nowrap;
    }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
      margin:10px 0 10px;
    }
    .kpiBox{
      border:1px solid #e6e8ef;
      border-radius:10px;
      padding:8px 10px;
      min-width:180px;
    }
    .kpiLabel{ font-size:10px; color:#555; }
    .kpiVal{ font-size:14px; font-weight:800; margin-top:2px; }
    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:10px;
    }
    thead th{
      text-align:left;
      padding:6px 6px;
      border-bottom:1px solid #cfd5e3;
      background:#f3f5fb;
      font-weight:800;
    }
    tbody td{
      padding:4px 6px;
      border-bottom:1px solid #eef1f6;
      vertical-align:top;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .c-date{ width:72px; }
    .c-dow{ width:34px; }
    .c-sum{ width:52px; text-align:right; }
    .c-note{ width:170px; }
    .c-ranges{ width:auto; }
    .sectionTitle{
      margin:12px 0 6px;
      font-size:12px;
      font-weight:900;
    }
    .notes{
      border:1px solid #e6e8ef;
      border-radius:10px;
      padding:8px 10px;
      font-size:10px;
    }
    .noteRow{
      display:flex;
      gap:10px;
      padding:3px 0;
      border-bottom:1px dashed #edf0f6;
    }
    .noteRow:last-child{ border-bottom:none; }
    .noteDate{ flex:0 0 auto; width:130px; color:#333; font-weight:700; }
    .noteText{ flex:1; color:#111; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .muted{ color:#666; }
    .foot{
      margin-top:10px;
      font-size:9px;
      color:#666;
      display:flex;
      justify-content:space-between;
      gap:12px;
    }
    @media print{
      .noteText{ white-space:nowrap; }
    }
  </style>
</head>
<body>
  <div class="head">
    <div>
      <h1>RAPORT GODZIN PRACY</h1>
      <div style="font-size:11px; color:#333; margin-top:2px;">Miesiąc: <strong>${escapeHtml(monthLabel)}</strong></div>
    </div>
    <div class="meta">
      Wygenerowano: ${escapeHtml(genText)}<br/>
      Stawka: ${escapeHtml(pln(db.settings.rate||0))} / h
    </div>
  </div>

  <div class="kpi">
    <div class="kpiBox">
      <div class="kpiLabel">Łączna liczba godzin</div>
      <div class="kpiVal">${escapeHtml(fmtHoursHuman(sumMin))} <span style="font-size:11px; font-weight:700; color:#333;">(${escapeHtml(fmtHM(sumMin))})</span></div>
    </div>
    <div class="kpiBox">
      <div class="kpiLabel">Wynagrodzenie</div>
      <div class="kpiVal">${escapeHtml(pln(sumPay))}</div>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th class="c-date">Data</th>
        <th class="c-dow">Dzień</th>
        <th class="c-ranges">Godziny / status</th>
        <th class="c-sum">Suma</th>
        <th class="c-note">Notatka (skrót)</th>
      </tr>
    </thead>
    <tbody>
      ${rows.join("")}
    </tbody>
  </table>

  <div class="sectionTitle">Notatki</div>
  <div class="notes">
    ${notesHtml}
  </div>

  <div class="foot">
    <div>Jeśli zapisujesz do PDF: w oknie drukowania wybierz „Zapisz jako PDF”.</div>
    <div>${escapeHtml(monthYM)}</div>
  </div>

  <script>
    window.addEventListener("load", () => {
      setTimeout(() => { window.print(); }, 250);
    });
  </script>
</body>
</html>`;
    }

    function openReportPdf(){
      const monthPick = $("monthPick");
      const monthYM = (monthPick && monthPick.value) ? monthPick.value : ym(todayISO());

      const html = buildReportHTML(monthYM);
      const w = window.open("", "_blank");
      if (!w){
        alert("Twoja przeglądarka zablokowała nowe okno. Zezwól na pop-upy dla tej strony i spróbuj ponownie.");
        return;
      }
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
    }

    // ===== UI =====
    const dlgBackBtn = $("dlgBack");
    if (dlgBackBtn) dlgBackBtn.onclick = closeDay;

    const openVacDialogBtn = $("openVacDialog");
    if (openVacDialogBtn) openVacDialogBtn.onclick = openVac;

    const openBulkDialogBtn = $("openBulkDialog");
    if (openBulkDialogBtn) openBulkDialogBtn.onclick = openBulk;

    const vacBackBtn = $("vacBack");
    if (vacBackBtn) vacBackBtn.onclick = closeVac;

    const bulkBackBtn = $("bulkBack");
    if (bulkBackBtn) bulkBackBtn.onclick = closeBulk;

    // usuwanie urlopu z dnia w modalu dnia
    const dlgRemoveVacationBtn = $("dlgRemoveVacation");
    if (dlgRemoveVacationBtn){
      dlgRemoveVacationBtn.onclick = ()=>{
        if (!dlgDate) return;
        if (!confirm("Usunąć urlop z tego dnia?")) return;
        const day = getDay(dlgDate) || { date: dlgDate, note:"", shifts:[], vacation:false };
        day.vacation = false;
        upsertDay(dlgDate, day);
        save();
        renderAll();
        renderDayDialog();
        setStatus("Usunięto urlop z dnia.");
      };
    }

    // Dodawanie zakresu w dniu
    const dlgAddShiftBtn = $("dlgAddShift");
    if (dlgAddShiftBtn){
      dlgAddShiftBtn.onclick = ()=>{
        if (!dlgDate) return;

        const dayNow = getDay(dlgDate);
        if (dayNow?.vacation) return;

        const start = $("dlgStart")?.value;
        const end = $("dlgEnd")?.value;
        if (!start || !end) return alert("Uzupełnij godzinę wejścia i wyjścia.");

        const day = getDay(dlgDate) || { date: dlgDate, note:"", shifts:[], vacation:false };
        day.shifts.push({ start, end });
        day.shifts.sort((a,b)=> (a.start || "").localeCompare(b.start || ""));

        upsertDay(dlgDate, day);

        if ($("dlgStart")) $("dlgStart").value = "";
        if ($("dlgEnd")) $("dlgEnd").value = "";
        save();
        renderAll();
        renderDayDialog();
        setStatus("Dodano zakres.");
      };
    }

    // Autosave notatki
    const dlgNoteEl = $("dlgNote");
    let noteTimer = null;
    if (dlgNoteEl){
      dlgNoteEl.addEventListener("input", ()=>{
        if (!dlgDate) return;
        clearTimeout(noteTimer);
        noteTimer = setTimeout(()=>{
          const note = (dlgNoteEl.value || "").trim();
          const day = getDay(dlgDate) || { date: dlgDate, note:"", shifts:[], vacation:false };
          day.note = note;
          upsertDay(dlgDate, day);
          save();
          renderAll();
          renderDayDialog();
          setStatus("Zapisano notatkę.");
        }, 250);
      });
    }

    // miesiąc picker
    const monthBar = $("monthBar");
    const monthPick = $("monthPick");
    if (monthBar && monthPick){
      monthBar.onclick = ()=>{
        if (typeof monthPick.showPicker === "function") monthPick.showPicker();
        else monthPick.focus();
      };
      monthPick.addEventListener("change", renderAll);
    }

    // Dzisiaj
    const todayBtn = $("todayBtn");
    if (todayBtn && monthPick){
      todayBtn.onclick = ()=>{
        const t = todayISO();
        monthPick.value = ym(t);
        shouldScrollToToday = true;
        renderAll();
      };
    }

    // FAB: otwórz dzisiaj
    const fabAdd = $("fabAdd");
    if (fabAdd){
      fabAdd.onclick = ()=>{
        const t = todayISO();
        if (monthPick){
          monthPick.value = ym(t);
          shouldScrollToToday = false;
          renderAll();
        }
        openDay(t);
      };
    }

    // urlop: zakres
    const setVacationRangeBtn = $("setVacationRange");
    if (setVacationRangeBtn){
      setVacationRangeBtn.onclick = ()=>{
        const from = $("vacFrom")?.value;
        const to = $("vacTo")?.value;
        const res = applyVacationRange(from, to, true);
        if (res.ok) closeVac();
      };
    }
    const clearVacationRangeBtn = $("clearVacationRange");
    if (clearVacationRangeBtn){
      clearVacationRangeBtn.onclick = ()=>{
        const from = $("vacFrom")?.value;
        const to = $("vacTo")?.value;
        applyVacationRange(from, to, false);
      };
    }

    // wiele godzin: dodaj / usuń
    const bulkApplyBtn = $("bulkApply");
    if (bulkApplyBtn){
      bulkApplyBtn.onclick = ()=>{
        const from = $("bulkFrom")?.value;
        const to = $("bulkTo")?.value;
        const start = $("bulkStart")?.value;
        const end = $("bulkEnd")?.value;
        const res = applyBulkHours(from, to, start, end, "add");
        if (res.ok) closeBulk();
      };
    }
    const bulkRemoveBtn = $("bulkRemove");
    if (bulkRemoveBtn){
      bulkRemoveBtn.onclick = ()=>{
        const from = $("bulkFrom")?.value;
        const to = $("bulkTo")?.value;
        const start = $("bulkStart")?.value;
        const end = $("bulkEnd")?.value;
        applyBulkHours(from, to, start, end, "remove");
      };
    }

    // narzędzia
    const reportBtn = $("reportPdf");
    if (reportBtn){
      reportBtn.onclick = openReportPdf;
    }

    const backupBtn = $("backupJson");
    if (backupBtn){
      backupBtn.onclick = ()=>{
        const blob = new Blob([JSON.stringify(db,null,2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `czas-pracy-backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
      };
    }

    const restoreBtn = $("restoreBtn");
    const restoreInput = $("restoreJson");
    if (restoreBtn && restoreInput){
      restoreBtn.onclick = ()=> restoreInput.click();
      restoreInput.onchange = async (ev)=>{
        const f = ev.target.files?.[0];
        if (!f) return;
        try{
          const txt = await f.text();
          const obj = JSON.parse(txt);
          db = obj;
          normalize();
          migrateIfNeeded();
          save();
          hydrateSettingsUI();
          renderAll();
          if (dlgDate) renderDayDialog();
          setStatus("Przywrócono dane z pliku JSON.");
        }catch{
          alert("Nie udało się wczytać pliku JSON.");
        }
      };
    }

    const clearMonthBtn = $("clearMonth");
    if (clearMonthBtn){
      clearMonthBtn.onclick = ()=>{
        const monthYM = (monthPick && monthPick.value) ? monthPick.value : ym(todayISO());
        if (!confirm("Usunąć wszystkie wpisy z tego miesiąca?")) return;
        db.entries = db.entries.filter(e => ym(e.date) !== monthYM);
        save();
        renderAll();
        setStatus("Wyczyszczono miesiąc.");
      };
    }

    const rateEl = $("rate");
    if (rateEl){
      rateEl.addEventListener("input", renderAll);
      rateEl.addEventListener("change", renderAll);
    }

    // INIT
    try{
      normalize();
      migrateIfNeeded();
      hydrateSettingsUI();

      const t = todayISO();
      if (monthPick) monthPick.value = ym(t);

      if ($("vacFrom") && !$("vacFrom").value) $("vacFrom").value = t;
      if ($("vacTo") && !$("vacTo").value) $("vacTo").value = t;

      if ($("bulkFrom") && !$("bulkFrom").value) $("bulkFrom").value = t;
      if ($("bulkTo") && !$("bulkTo").value) $("bulkTo").value = t;

      renderAll();
    } catch(err){
      const msg = (err && err.message) ? err.message : String(err);
      const el = document.getElementById("status");
      if (el) el.textContent = "BŁĄD INIT: " + msg;
    }
  })();
  </script>
</body>
</html>
