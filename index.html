<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Godziny pracy</title>
  <meta name="theme-color" content="#f6f7fb" />
  <meta name="color-scheme" content="light">
  <link rel="manifest" href="/czas-pracy-pwa/manifest.webmanifest">

  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:#f6f7fb;color:#111}
    .wrap{max-width:980px;margin:24px auto;padding:0 14px}
    .card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
    @media(max-width:820px){.col-3,.col-4,.col-6{grid-column:span 12}}
    label{display:block;font-size:12px;color:#444;margin-bottom:6px}
    input,button,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #d7dbe7;background:#fff;font-size:14px;box-sizing:border-box}
    textarea{min-height:44px;resize:vertical}
    button{cursor:pointer;border:none;background:#111;color:#fff}
    button.secondary{background:#eef1f8;color:#111;border:1px solid #d7dbe7}
    button.danger{background:#d92d20}
    h1{font-size:20px;margin:0 0 10px}
    h2{font-size:16px;margin:0 0 10px}
    .muted{color:#666;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1;min-width:160px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef1f8;font-size:12px}

    /* details / tr√≥jkƒÖt + animacja */
    details{border-radius:12px}
    details summary{
      cursor:pointer;
      font-weight:700;
      user-select:none;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:2px 0;
    }
    details summary::-webkit-details-marker{display:none;}
    .chev{
      width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;
      border-radius:8px;background:#eef1f8;border:1px solid #d7dbe7;
      transition:transform .18s ease;
      flex:0 0 auto;
      margin-left:10px;
    }
    details[open] .chev{transform:rotate(180deg);}
    .panel{overflow:hidden;animation:panelIn .18s ease;}
    @keyframes panelIn{
      from{opacity:.4; transform:translateY(-4px)}
      to{opacity:1; transform:translateY(0)}
    }

    /* ===== KALENDARZ ===== */
    .calWrap{width:100%;}
    .calHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .calHead .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .calMonth{
      display:flex;gap:8px;align-items:center;
      background:#eef1f8;border:1px solid #d7dbe7;border-radius:12px;padding:8px 10px;
    }
    .calMonth button{
      width:auto;padding:8px 10px;border-radius:10px;border:1px solid #d7dbe7;background:#fff;color:#111;
      cursor:pointer;
    }
    .calMonth input{
      width:auto;min-width:160px;border:none;background:transparent;padding:8px 6px;
    }

    .calGrid{
      display:grid;
      grid-template-columns:repeat(7, minmax(0, 1fr));
      gap:10px;
    }
    .calDow{
      font-size:12px;color:#666;text-align:center;padding:6px 0;
    }

    .dayCell{
      background:#fff;border:1px solid #eef1f8;border-radius:14px;
      padding:10px;
      min-height:92px;
      box-shadow:0 6px 18px rgba(0,0,0,.04);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      gap:6px;
    }
    .dayCell:hover{border-color:#d7dbe7}
    .dayTop{display:flex;align-items:baseline;justify-content:space-between;gap:8px}
    .dayNum{font-size:18px;font-weight:600;color:#1b2a3a}
    .dayNum.has{font-weight:800}
    .dayNum.mutedNum{color:#9aa6b2;font-weight:600}
    .dayNum.weekend{color:#c53030}
    .hasBar{
      height:4px;border-radius:999px;background:#111;opacity:.22;
      margin-top:-2px;
    }
    .dayLines{
      font-size:12px;color:#607080;line-height:1.35;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
    }
    .dayLines .plus{font-weight:700;color:#111}
    @media(max-width:640px){
      .calGrid{gap:8px}
      .dayCell{min-height:84px;padding:9px}
      .dayNum{font-size:16px}
    }

    /* ===== MODAL (dialog) ===== */
    dialog{
      border:none;border-radius:16px;padding:0;
      width:min(720px, calc(100vw - 22px));
      box-shadow:0 18px 60px rgba(0,0,0,.25);
    }
    dialog::backdrop{background:rgba(17,17,17,.45)}
    .modalCard{padding:14px}
    .modalHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px;border-bottom:1px solid #eef1f8;
    }
    .modalHead h3{margin:0;font-size:16px}
    .modalBody{padding:14px}
    .shiftList{display:grid;gap:10px;margin-top:10px}
    .shiftItem{
      border:1px solid #eef1f8;border-radius:14px;padding:10px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
      background:#fff;
    }
    .shiftItem .times{font-weight:700}
    .shiftItem .mins{color:#666;font-size:12px}
    .miniBtn{
      width:auto;padding:8px 10px;border-radius:10px;border:1px solid #d7dbe7;background:#eef1f8;color:#111;
    }
    .miniBtn.danger{background:#ffe6e3;border-color:#ffb4ab;color:#7a1410}

    .divider{height:1px;background:#eef1f8;margin:14px 0}

    /* druk / PDF */
    @media print{
      body{background:#fff}
      .wrap{margin:0;padding:0;max-width:none}
      .card{box-shadow:none;border-radius:0;padding:0}
      button, input, textarea, details, dialog{display:none !important}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card" style="margin-bottom:14px;">
      <h1>Godziny pracy ‚è±Ô∏è</h1>
      <div class="muted" id="status"></div>
    </div>

    <!-- Dodaj / dopisz zakres (szybkie) -->
    <div class="grid" style="margin-bottom:14px;">
      <div class="card col-12">
        <h2>Dodaj zakres</h2>
        <div class="grid">
          <div class="col-3">
            <label>Data</label>
            <input id="date" type="date" />
          </div>
          <div class="col-3">
            <label>Wej≈õcie</label>
            <input id="start" type="time" />
          </div>
          <div class="col-3">
            <label>Wyj≈õcie</label>
            <input id="end" type="time" />
          </div>
          <div class="col-3">
            <label>&nbsp;</label>
            <button id="addShiftBtn">Dodaj zakres</button>
          </div>
          <div class="col-12">
            <label>Notatka do dnia</label>
            <textarea id="note" placeholder="Opcjonalnie... (np. zaliczka -100 z≈Ç)"></textarea>
          </div>
          <div class="col-12">
            <button class="secondary" id="openDayBtn">Otw√≥rz ten dzie≈Ñ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ustawienia pracy -->
    <div class="grid" style="margin-bottom:14px;">
      <div class="card col-12">
        <details id="extrasPanel">
          <summary>
            <span>Ustawienia pracy</span>
            <span class="chev">‚ñæ</span>
          </summary>
          <div class="panel">
            <div class="grid" style="margin-top:12px;">
              <div class="col-4">
                <label>Stawka godzinowa (PLN)</label>
                <input id="rate" type="number" step="0.01" min="0" value="40" />
              </div>
            </div>
          </div>
        </details>
      </div>
    </div>

    <!-- PODSUMOWANIE MIESIƒÑCA: KALENDARZ -->
    <div class="grid">
      <div class="card col-12">
        <div class="calHead">
          <div>
            <h2 style="margin:0;">Podsumowanie miesiƒÖca</h2>
            <div class="muted">Kliknij dzie≈Ñ, ≈ºeby zobaczyƒá szczeg√≥≈Çy i akcje.</div>
          </div>

          <div class="calMonth">
            <button id="prevMonth" aria-label="Poprzedni miesiƒÖc">‚Äπ</button>
            <input id="monthPick" type="month" />
            <button id="nextMonth" aria-label="Nastƒôpny miesiƒÖc">‚Ä∫</button>
          </div>
        </div>

        <div class="calWrap">
          <div class="calGrid" id="dowRow" style="margin-bottom:6px;"></div>
          <div class="calGrid" id="calGrid"></div>
        </div>

        <div class="divider"></div>

        <div class="grid" style="margin-top:10px;">
          <div class="col-6">
            <div class="muted">Suma godzin</div>
            <div style="font-size:22px;font-weight:800" id="sumHours">0:00</div>
          </div>
          <div class="col-6">
            <div class="muted">Wyp≈Çata</div>
            <div style="font-size:22px;font-weight:800" id="sumPay">0,00 z≈Ç</div>
          </div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button class="secondary" id="printPdfBtn">Raport PDF / Wydrukuj</button>
        </div>
      </div>
    </div>

    <!-- Narzƒôdzia -->
    <div class="grid" style="margin-top:14px;">
      <div class="card col-12">
        <details id="toolsPanel">
          <summary>
            <span>Narzƒôdzia</span>
            <span class="chev">‚ñæ</span>
          </summary>
          <div class="panel">
            <div class="row" style="margin-top:12px;">
              <button class="danger" id="clearMonth">Usu≈Ñ wpisy z tego miesiƒÖca</button>
              <button class="secondary" id="backupJson">Backup JSON</button>
              <input id="restoreJson" type="file" accept="application/json" style="display:none" />
              <button class="secondary" id="restoreBtn">Przywr√≥ƒá z JSON</button>
            </div>
            <div class="muted" style="margin-top:8px;">
              Tip: r√≥b backup raz na jaki≈õ czas (Google Drive / mail) i masz spok√≥j.
            </div>
          </div>
        </details>
      </div>
    </div>
  </div>

  <!-- MODAL DNIA -->
  <dialog id="dayDialog">
    <div class="modalHead">
      <h3 id="dlgTitle">Dzie≈Ñ</h3>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="secondary" id="dlgClose" style="width:auto;">Zamknij</button>
      </div>
    </div>

    <div class="modalBody">
      <div class="grid">
        <div class="col-6">
          <label>Dodaj zakres (do tego dnia)</label>
          <div class="row" style="gap:8px;">
            <input id="dlgStart" type="time" style="min-width:140px;" />
            <input id="dlgEnd" type="time" style="min-width:140px;" />
            <button id="dlgAddShift" style="width:auto;">Dodaj</button>
          </div>
          <div class="muted" style="margin-top:6px;">Mo≈ºesz dodawaƒá kilka zakres√≥w (np. przerwa w ciƒÖgu dnia).</div>
        </div>

        <div class="col-6">
          <label>Notatka</label>
          <textarea id="dlgNote" placeholder="Opcjonalnie..."></textarea>
          <button class="secondary" id="dlgSaveNote" style="margin-top:8px;">Zapisz notatkƒô</button>
        </div>

        <div class="col-12">
          <div class="divider"></div>
          <div style="display:flex; justify-content:space-between; align-items:baseline; gap:10px; flex-wrap:wrap;">
            <div>
              <strong>Zakresy</strong>
              <div class="muted" id="dlgSummary"></div>
            </div>
            <button class="danger" id="dlgDeleteDay" style="width:auto;">Usu≈Ñ ca≈Çy dzie≈Ñ</button>
          </div>

          <div class="shiftList" id="dlgShifts"></div>
        </div>
      </div>
    </div>
  </dialog>

<script>
(() => // === DEBUG: pokazuj b≈Çƒôdy w aplikacji (na telefonie nie masz konsoli) ===
  const showErr = (msg) => {
    const el = document.getElementById("status");
    if (el) el.textContent = "B≈ÅƒÑD: " + msg;
  };

  window.addEventListener("error", (e) => {
    showErr(e.message || "Nieznany b≈ÇƒÖd JS");
  });

  window.addEventListener("unhandledrejection", (e) => {
    showErr((e.reason && e.reason.message) ? e.reason.message : String(e.reason || "Promise error"));
  });
  {
  // PWA SW (GitHub Pages path)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/czas-pracy-pwa/sw.js", { scope: "/czas-pracy-pwa/" });
  }

  const $ = (id) => document.getElementById(id);
  const pad2 = (n) => String(n).padStart(2,"0");

  const todayISO = () => {
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  };

  const ym = (dateISO) => dateISO.slice(0,7);

  const fmtDMY = (dateISO) => {
    if (!dateISO) return "";
    const [y,m,d] = dateISO.split("-");
    return `${d}-${m}-${y}`;
  };

  const fmtMonthLabel = (y, m) => `${pad2(m)}-${y}`; // MM-YYYY

  const STORAGE_KEY = "worktime_pwa_v1";
  let db = load() || { settings:{ rate:40 }, entries:[] };

  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }
  function load(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch { return null; }
  }

  function migrateIfNeeded(){
    // Stare wpisy: {date,start,end,note} -> {date, shifts:[{start,end}], note}
    let changed = false;
    db.entries = (Array.isArray(db.entries) ? db.entries : []).map(e=>{
      if (!e) return e;
      if (Array.isArray(e.shifts)) return e;

      const shifts = [];
      if (e.start && e.end) shifts.push({ start:e.start, end:e.end });

      const ne = { date:e.date, note:e.note || "", shifts };
      changed = true;
      return ne;
    });

    if (changed) save();
  }

  function normalize(){
    db.settings = db.settings || {};
    db.settings.rate = Number(db.settings.rate ?? 40);
    db.entries = Array.isArray(db.entries) ? db.entries : [];

    for (const e of db.entries){
      e.shifts = Array.isArray(e.shifts) ? e.shifts : [];
      e.note = e.note || "";
    }
  }

  function setStatus(t){ $("status").textContent = t || ""; }

  function minutesBetween(dateISO, start, end) {
    const [y,m,d] = dateISO.split("-").map(Number);
    const [sh,sm] = start.split(":").map(Number);
    const [eh,em] = end.split(":").map(Number);
    const a = new Date(y,m-1,d,sh,sm,0,0);
    let b = new Date(y,m-1,d,eh,em,0,0);
    if (b < a) b = new Date(y,m-1,d+1,eh,em,0,0);
    return Math.round((b-a)/60000);
  }

  function fmtHM(mins){
    const h = Math.floor(mins/60);
    const m = mins%60;
    return `${h}:${pad2(m)}`;
  }

  function pln(x){ return x.toLocaleString("pl-PL",{style:"currency",currency:"PLN"}); }

  function readSettingsFromUI(){
    db.settings.rate = Number($("rate").value || 0);
  }
  function hydrateSettingsUI(){
    $("rate").value = db.settings.rate;
  }

  function getDay(date){
    return db.entries.find(e => e.date === date) || null;
  }

  function upsertDay(date, patch){
    const i = db.entries.findIndex(e => e.date === date);
    if (i >= 0) db.entries[i] = { ...db.entries[i], ...patch };
    else db.entries.push({ date, note:"", shifts:[], ...patch });
    db.entries.sort((a,b)=>a.date.localeCompare(b.date));
  }

  function deleteDay(dateISO){
    db.entries = db.entries.filter(e => e.date !== dateISO);
  }

  function computeDayMinutes(day){
    let total = 0;
    for (const s of day.shifts){
      if (!s?.start || !s?.end) continue;
      total += Math.max(0, minutesBetween(day.date, s.start, s.end));
    }
    return total;
  }

  function computeMonthMinutes(monthYM){
    const days = db.entries.filter(e => ym(e.date) === monthYM);
    return days.reduce((acc, d)=> acc + computeDayMinutes(d), 0);
  }

  function safeText(s){
    return (s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  // ===== KALENDARZ RENDER =====
  const DOW = ["Pn","Wt","≈ör","Czw","Pt","Sb","Nd"];

  function mondayIndex(jsDay){ // JS: 0=Sun..6=Sat -> 0=Mon..6=Sun
    return (jsDay + 6) % 7;
  }

  function daysInMonth(year, month1){ // month1: 1..12
    return new Date(year, month1, 0).getDate();
  }

  function renderDow(){
    $("dowRow").innerHTML = DOW.map(d => `<div class="calDow">${d}</div>`).join("");
  }

  function renderCalendar(monthYM){
    const [Y, M] = monthYM.split("-").map(Number); // M: 1..12
    const first = new Date(Y, M-1, 1);
    const firstIdx = mondayIndex(first.getDay()); // 0..6
    const dim = daysInMonth(Y, M);

    const prevMonth = new Date(Y, M-2, 1);
    const prevY = prevMonth.getFullYear();
    const prevM = prevMonth.getMonth()+1;
    const prevDim = daysInMonth(prevY, prevM);

    // 42 p√≥l (6 tygodni) ‚Äì wyglƒÖda najczy≈õciej
    const totalCells = 42;
    const cells = [];

    for (let i=0;i<totalCells;i++){
      const dayNum = i - firstIdx + 1;
      let cellY=Y, cellM=M, cellD=dayNum, inMonth=true;

      if (dayNum < 1){
        inMonth = false;
        cellY = prevY; cellM = prevM; cellD = prevDim + dayNum;
      } else if (dayNum > dim){
        inMonth = false;
        const next = new Date(Y, M, 1);
        cellY = next.getFullYear(); cellM = next.getMonth()+1; cellD = dayNum - dim;
      }

      const dateISO = `${cellY}-${pad2(cellM)}-${pad2(cellD)}`;
      const jsDow = new Date(cellY, cellM-1, cellD).getDay(); // 0..6 (Sun..Sat)
      const isWeekend = (jsDow === 0 || jsDow === 6);

      const day = getDay(dateISO);
      const has = !!(day && day.shifts && day.shifts.length);

      // linie jak w screenie: "od 06:00 do 14:00"
      let lines = "";
      if (day && (day.shifts?.length || day.note)){
        const maxLines = 2;
        const shiftLines = (day.shifts || []).slice(0, maxLines).map(s => {
          const a = s.start || "-";
          const b = s.end || "-";
          return `od ${a}<br>do ${b}`;
        }).join("<br>");

        let extra = "";
        if ((day.shifts || []).length > maxLines) extra = `<br><span class="plus">+${(day.shifts.length - maxLines)}</span>`;
        if (shiftLines) lines += shiftLines + extra;

        // ikona ‚Äúnotatka‚Äù je≈õli jest notatka
        if (day.note && day.note.trim()){
          lines += (lines ? "<br>" : "") + "üìù";
        }
      }

      const numClass = [
        "dayNum",
        !inMonth ? "mutedNum" : "",
        isWeekend ? "weekend" : "",
        has ? "has" : ""
      ].filter(Boolean).join(" ");

      cells.push(`
        <div class="dayCell" data-date="${dateISO}">
          <div class="dayTop">
            <div class="${numClass}">${cellD}</div>
          </div>
          ${has ? `<div class="hasBar"></div>` : `<div style="height:4px;"></div>`}
          <div class="dayLines">${lines || ""}</div>
        </div>
      `);
    }

    $("calGrid").innerHTML = cells.join("");

    // click handlers
    document.querySelectorAll(".dayCell[data-date]").forEach(el=>{
      el.onclick = ()=>{
        const date = el.getAttribute("data-date");
        openDay(date);
      };
    });
  }

  // ===== MODAL DNIA =====
  const dlg = $("dayDialog");
  let dlgDate = null;

  function openDay(dateISO){
    dlgDate = dateISO;

    // zsynchronizuj g√≥rny formularz
    $("date").value = dateISO;

    const day = getDay(dateISO) || { date: dateISO, note:"", shifts:[] };

    $("dlgTitle").textContent = `Dzie≈Ñ: ${fmtDMY(dateISO)}`;
    $("dlgStart").value = "";
    $("dlgEnd").value = "";
    $("dlgNote").value = day.note || "";

    renderDayDialog();

    if (typeof dlg.showModal === "function") dlg.showModal();
    else dlg.setAttribute("open",""); // fallback
  }

  function closeDay(){
    dlgDate = null;
    if (typeof dlg.close === "function") dlg.close();
    else dlg.removeAttribute("open");
  }

  function renderDayDialog(){
    const day = getDay(dlgDate) || { date: dlgDate, note:"", shifts:[] };
    const mins = computeDayMinutes(day);
    $("dlgSummary").textContent = `Suma dnia: ${mins ? fmtHM(mins) : "0:00"}`;

    const items = (day.shifts || []).map((s, idx)=>{
      const a = s.start || "-";
      const b = s.end || "-";
      const m = (s.start && s.end) ? Math.max(0, minutesBetween(day.date, s.start, s.end)) : 0;
      return `
        <div class="shiftItem">
          <div>
            <div class="times">${a} ‚Äì ${b}</div>
            <div class="mins">${m ? fmtHM(m) : "-"}</div>
          </div>
          <button class="miniBtn danger" data-delshift="${idx}">Usu≈Ñ</button>
        </div>
      `;
    }).join("");

    $("dlgShifts").innerHTML = items || `<div class="muted">Brak zakres√≥w. Dodaj pierwszy powy≈ºej.</div>`;

    document.querySelectorAll("[data-delshift
